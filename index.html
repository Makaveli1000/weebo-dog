<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snt.L.Mo. Exclusive Sports Hub</title>
    
    <script src="/env-config.js"></script> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Define a custom color scheme based on St. Louis sports (Metro Blue/Red/Yellow) */
        .text-metro-primary { color: #0047AB; /* Navy Blue */ }
        .bg-metro-primary { background-color: #0047AB; }
        .border-metro-primary { border-color: #0047AB; }
        .text-metro-accent { color: #DC143C; /* Red */ }
        .bg-metro-accent { background-color: #DC143C; }
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); }
        .loading-overlay { display: flex; justify-content: center; align-items: center; background-color: rgba(255, 255, 255, 0.8); z-index: 100; }
        #tts-button {
            background-color: #ef4444; 
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #tts-button:hover:not(:disabled) {
            background-color: #dc2626; 
        }
        #tts-button:disabled {
            background-color: #9ca3af; 
            cursor: not-allowed;
        }
        /* Custom style for Zeus flying function */
        .flying-zeus {
            transition: transform 1s ease-out, opacity 1s ease-out;
            will-change: transform, opacity;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loading-overlay" class="fixed inset-0 loading-overlay z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-metro-primary mx-auto"></div>
            <p class="mt-4 text-gray-700 font-semibold">Initializing Zeus Hub Security...</p>
        </div>
    </div>

    <header class="bg-metro-primary text-white shadow-lg z-30">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold tracking-wider">SNTLMO Hub</h1>
            <div class="flex items-center space-x-4">
                <div class="hidden sm:flex items-center space-x-3 text-sm font-medium">
                    <span id="user-status-display" class="text-white">Logged Out</span>
                    <span class="bg-indigo-500 py-1 px-3 rounded-full hidden sm:block">ID: <span id="user-id-display" class="font-mono text-xs"></span></span>
                </div>
                <button id="header-auth-btn" onclick="toggleLoginModal(true)" class="bg-white text-metro-primary hover:bg-gray-200 px-3 py-1 rounded-full text-sm font-semibold transition hidden">Login/Register</button>
                <button id="account-btn" onclick="toggleAccountModal(true)" class="bg-white text-metro-primary hover:bg-gray-200 px-3 py-1 rounded-full text-sm font-semibold transition hidden">Account</button>
                <button id="admin-btn" onclick="toggleAdminModal(true)" class="bg-yellow-400 text-gray-900 hover:bg-yellow-500 px-3 py-1 rounded-full text-sm font-bold transition hidden">Admin</button>
            </div>
        </div>
    </header>

    <svg id="zeus-avatar-svg" class="w-10 h-10 fixed right-4 bottom-4 z-40 text-yellow-500 shadow-xl" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4.5H8.5l3.5-7v4.5H15l-3.5 7z"/>
        <path fill="none" d="M0 0h24v24H0z"/>
    </svg>

    <div id="paywall-content" class="flex-grow flex items-center justify-center p-8 hidden">
        <div class="max-w-xl text-center bg-white p-10 rounded-xl shadow-2xl border-t-4 border-metro-accent">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Access Denied: PRO MEMBERS ONLY</h2>
            <p class="text-lg text-gray-600 mb-6">You need to be a **PRO MEMBER** to access the live data feeds, chat, and locker room.</p>
            <button onclick="toggleCashAppModal(true)" class="bg-metro-accent text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-metro-accent/80 transition duration-300">
                Upgrade to PRO Membership ($10.00 / Year)
            </button>
            <p class="text-sm text-gray-500 mt-4">Already a member? Use the Login/Register button in the header.</p>
        </div>
    </div>
    
    <main id="main-content" class="flex-grow max-w-7xl mx-auto py-8 sm:px-6 lg:px-8 w-full hidden">
        <div class="px-4 py-6 sm:px-0">
            
            <div id="status-message-container" class="mb-4 hidden">
                <p id="status-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative font-medium"></p>
            </div>
            
            <button id="narrator-launch-btn" onclick="startZeusNarratorTour()" class="fixed top-20 right-4 z-40 bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-full shadow-xl hover:bg-yellow-500 hidden">
                Launch Zeus Tour!
            </button>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 space-y-8">
                    
                    <div class="bg-white shadow-xl rounded-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                            Live Sports Data Feed
                            <span id="latest-data" class="text-sm font-normal text-metro-primary">Awaiting data...</span>
                        </h2>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-3">
                            <h3 class="text-lg font-semibold text-gray-700">Broadcast Live Announcement (TTS)</h3>
                            <textarea id="tts-input" rows="2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-metro-primary focus:border-metro-primary" placeholder="Enter message to broadcast, e.g., 'The Vashon game starts in 5 minutes!'"></textarea>
                            <div class="flex justify-between items-center">
                                <button id="tts-button" onclick="window.generateAndSpeak()" disabled>
                                    Announce Now!
                                </button>
                                <div id="tts-status" class="text-xs font-medium text-gray-500">Status: Requires Gemini API Key</div>
                            </div>
                        </div>

                        <div class="mt-6 bg-indigo-50 p-6 rounded-lg border border-indigo-200">
                            <p class="text-indigo-800 font-medium">Raw Data Stream:</p>
                            <pre id="data-stream" class="text-sm text-indigo-700 mt-2 bg-indigo-100 p-3 rounded-md overflow-x-auto h-32">Awaiting real-time updates from Firestore...</pre>
                        </div>
                    </div>
                    
                    <div id="scoreboard-section" class="bg-white shadow-xl rounded-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                            Community Scoreboard & Highlights
                            <button onclick="toggleSportsDataModal(true)" class="bg-green-500 text-white font-bold py-1 px-3 rounded-full text-sm hover:bg-green-600 transition">
                                + Submit Data
                            </button>
                        </h2>
                        <div id="sports-data-display" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <p class="text-center text-gray-500 py-8 col-span-full">Loading sports data...</p>
                        </div>
                    </div>

                    <div id="interview-section" class="bg-white shadow-xl rounded-xl p-6">
                        <h2 id="interview-heading" class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">Exclusive Interview Corner</h2>
                        <p class="text-gray-600 mb-4">Submit your questions for our next featured St. Louis athlete!</p>
                        <textarea rows="3" class="w-full p-3 border rounded-lg focus:ring-metro-accent focus:border-metro-accent" placeholder="I'd like to ask..."></textarea>
                        <button class="mt-3 bg-metro-accent text-white font-bold py-2 px-5 rounded-full hover:bg-metro-accent/90 transition">
                            Submit Question
                        </button>
                    </div>

                    <div id="locker-room-section" class="bg-white shadow-xl rounded-xl p-6">
                        <h2 id="locker-heading" class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                            Personal Media Locker
                            <button id="locker-upload-btn" onclick="handleFileUpload()" class="bg-blue-500 text-white font-bold py-1 px-3 rounded-full text-sm hover:bg-blue-600 transition" disabled>
                                Upload Media
                            </button>
                        </h2>
                        <input type="file" id="media-file-input" class="hidden" onchange="handleFileUpload()">
                        <p id="locker-upload-message" class="text-sm text-red-500 font-medium my-2 hidden">
                            Limit reached! Upgrade to PRO for unlimited storage.
                        </p>
                        <p id="locker-status-text" class="text-sm text-orange-600 mb-4">Capacity: Loading...</p>
                        <div id="locker-media-display" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            </div>
                    </div>

                    <div class="bg-gray-800 text-white rounded-xl p-6 shadow-xl">
                        <h3 class="text-xl font-semibold border-b border-gray-600 pb-3 mb-4">System Health & Debug</h3>
                        <ul class="space-y-3 text-sm">
                            <li id="debug-firebase-config">Firebase Config: <span class="text-yellow-400">Checking...</span></li>
                            <li id="debug-auth-token">Initial Auth Token: <span class="text-yellow-400">Checking...</span></li>
                            <li id="debug-app-id">App ID: <span class="text-yellow-400">Checking...</span></li>
                        </ul>
                    </div>
                </div>
                
                <div class="lg:col-span-1 space-y-8">
                    
                    <div class="bg-white shadow-xl rounded-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">St. Louis Sports Birthdays</h3>
                        <div id="birthday-tracker-display" class="space-y-3">
                            </div>
                    </div>

                    <div class="card bg-green-50 p-6 rounded-xl shadow-lg border border-green-200">
                        <h3 class="text-xl font-bold text-green-700 mb-4">System Activity</h3>
                        <p class="text-gray-700">Last Database Ping:</p>
                        <div id="last-activity" class="text-xl font-extrabold text-green-600 mt-1">N/A</div>
                    </div>
                    
                    <div class="card bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-300 flex flex-col items-center">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Quick Share Link (QR)</h3>
                        <div id="qrcode-container" class="p-3 bg-white rounded-lg border border-gray-400">
                            </div>
                        <p class="text-xs text-gray-500 mt-3">Scan this code to immediately share the hub URL.</p>
                    </div>

                    <div class="bg-white shadow-xl rounded-xl p-6 h-96 flex flex-col">
                        <div class="flex justify-around mb-4 border-b pb-2">
                            <button id="mode-active-btn" onclick="toggleSidebarMode('ACTIVE')" class="text-sm font-bold p-2 rounded-lg bg-metro-primary text-white transition">Active Users</button>
                            <button id="mode-leaderboard-btn" onclick="toggleSidebarMode('LEADERBOARD')" class="text-sm font-bold p-2 rounded-lg bg-gray-200 text-gray-700 transition">Leaderboard</button>
                        </div>
                        <div class="flex-grow overflow-y-auto">
                            <div id="active-users-list" class="space-y-1">
                                </div>
                            <div id="leaderboard-list" class="space-y-1 hidden">
                                </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="chat-section" class="bg-white shadow-xl rounded-xl p-6 mt-8">
                <h2 id="chat-heading" class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">Team Chat</h2>
                
                <div id="chat-messages" class="h-64 overflow-y-auto p-4 mb-4 border border-gray-300 rounded-lg bg-gray-100 space-y-3">
                    <p class="text-center text-gray-500">Loading chat history...</p>
                </div>

                <div class="flex space-x-3">
                    <select id="chat-mode-toggle" onchange="toggleChatMode()" class="p-2 border rounded-lg text-sm bg-white">
                        <option value="public">Public</option>
                        <option value="private">Private (PM)</option>
                    </select>
                    <input type="text" id="recipient-id-input" placeholder="Recipient ID" class="hidden p-2 border rounded-lg text-sm w-1/4">
                    <input type="text" id="message-input" placeholder="Send a message to the team..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-metro-primary focus:border-metro-primary">
                    <button onclick="sendMessage('text')" class="bg-metro-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-metro-primary/80 transition">
                        Send
                    </button>
                </div>
                <div id="recipient-container" class="mt-2 text-sm text-gray-600 hidden">
                    <span id="recipient-display"></span>
                    <button id="video-call-btn" onclick="sendMessage('VIDEO_REQUEST', 'Video call request')" class="ml-3 bg-red-500 text-white text-xs font-bold py-1 px-2 rounded-full hover:bg-red-600 transition hidden">
                        üìπ Request Video Call
                    </button>
                </div>
            </div>

        </div>
    </main>

    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold text-metro-primary mb-4">Hub Login</h3>
            <p id="login-error" class="text-red-500 text-sm mb-3"></p>
            <input type="email" id="login-email" placeholder="Email" class="w-full p-3 mb-3 border rounded-lg">
            <input type="password" id="login-password" placeholder="Password (min 6 chars)" class="w-full p-3 mb-4 border rounded-lg">
            
            <button onclick="logIn()" class="w-full bg-metro-primary text-white font-bold py-3 rounded-lg hover:bg-metro-primary/80 transition mb-2">Login</button>
            <button onclick="register()" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition mb-4">Register</button>
            
            <p class="text-xs text-gray-500 mb-3">--- OR USE QR LOGIN ---</p>
            <div id="login-qrcode" class="mx-auto w-[100px] h-[100px] mb-3"></div>
            <input type="text" id="login-qr-id-input" readonly class="w-full p-2 text-sm text-center border rounded-lg bg-gray-100 mb-2" onclick="copyQrCodeText()" title="Click to copy User ID">
            <button onclick="copyQrCodeText()" class="text-xs text-metro-accent hover:underline">Copy User ID</button>

            <button onclick="toggleLoginModal(false)" class="text-gray-500 hover:text-gray-700 mt-4 block mx-auto text-sm">Close</button>
        </div>
    </div>
    
    <div id="account-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
            <h3 class="text-2xl font-bold text-metro-primary mb-4">Account Settings</h3>
            <div class="space-y-4">
                <p class="text-sm">UID: <span id="account-uid" class="font-mono text-xs bg-gray-100 p-1 rounded"></span></p>
                <p class="text-sm">Premium Status: <span id="account-premium-status" class="font-bold"></span></p>
                
                <div>
                    <label for="account-nickname" class="block text-sm font-medium text-gray-700">Nickname:</label>
                    <div class="flex space-x-2 mt-1">
                        <input type="text" id="account-nickname" class="flex-grow p-2 border rounded-lg">
                        <button onclick="saveAccountNickname()" class="bg-metro-primary text-white text-sm font-bold px-3 rounded-lg hover:bg-metro-primary/80">Save</button>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <label for="account-new-password" class="block text-sm font-medium text-gray-700">Change Password:</label>
                    <input type="password" id="account-new-password" placeholder="New Password (min 6 chars)" class="w-full p-2 mt-1 border rounded-lg">
                    <p id="account-password-error" class="text-red-500 text-xs mt-1"></p>
                    <button onclick="updateUserPassword()" class="mt-3 bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Update Password</button>
                </div>
                
                <button onclick="logOut(); toggleAccountModal(false);" class="mt-4 bg-gray-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Log Out</button>
            </div>
            <button onclick="toggleAccountModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>

    <div id="cashapp-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold text-metro-primary mb-4">PRO MEMBERSHIP - $10.00</h3>
            <p class="text-gray-700 mb-4">Please scan the QR code to complete payment via Cash App.</p>
            <div id="cashapp-qrcode" class="mx-auto w-[180px] h-[180px] mb-4"></div>
            <p class="text-lg font-bold text-green-600 mb-2">Cash Tag: $Mac100dime</p>
            <p class="text-xs text-red-500 mb-4">After payment, click "Simulate Success" below for instant access.</p>
            <button onclick="simulatePaymentSuccess()" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition mb-3">
                Simulate Payment Success (Get Access Now)
            </button>
            <button onclick="toggleCashAppModal(false)" class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
        </div>
    </div>
    
    <div id="sports-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold text-metro-primary mb-4">Submit Sports Data</h3>
            <p class="text-red-500 text-sm mb-3">Contribution increases your standing on the Leaderboard!</p>
            
            <div class="space-y-3">
                <select id="data-type" class="w-full p-3 border rounded-lg">
                    <option value="SCORE">Live Score Update</option>
                    <option value="HIGHLIGHT">Highlight Video/Clip</option>
                    <option value="ACTIVITY">General Team Activity</option>
                </select>
                
                <select id="data-school" class="w-full p-3 border rounded-lg">
                    <option value="VASHON">VASHON - Wolverines üê∫</option>
                    <option value="SUMNER">SUMNER - Bulldogs üê∂</option>
                    <option value="SOLDAN">SOLDAN - Tigers üêÖ</option>
                    <option value="MCKINLEY">MCKINLEY - Goldbugs üêû</option>
                    <option value="ROOSEVELT">ROOSEVELT - Rough Riders üêé</option>
                    <option value="OTHER">Other STL Area School</option>
                </select>
                
                <input type="text" id="data-title" placeholder="Title (e.g., Vashon 68 - Soldan 55)" class="w-full p-3 border rounded-lg">
                <textarea id="data-details" rows="3" placeholder="Details (e.g., 4th quarter score difference)" class="w-full p-3 border rounded-lg"></textarea>
                <input type="url" id="data-video-url" placeholder="Optional: YouTube/Highlight Video URL" class="w-full p-3 border rounded-lg">
            </div>
            
            <button onclick="flyZeusAndClick('submit-data-btn', submitSportsData, 800)" id="submit-data-btn" class="w-full mt-6 bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition">
                Submit Data to Scoreboard
            </button>
            
            <button onclick="toggleSportsDataModal(false)" class="mt-4 text-gray-500 hover:text-gray-700 text-sm block mx-auto">Cancel</button>
            <button onclick="window.upgradeToPremiumForOneYear()" class="text-xs text-red-400 hover:text-red-600 block mx-auto mt-2">ADMIN: Test Upgrade</button>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-3xl w-full h-4/5 flex flex-col">
            <h3 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">Admin Panel (User Management)</h3>
            <p class="text-sm text-gray-600 mb-4">Admin UID: <span class="font-mono text-xs text-red-700">05806734626095127961</span></p>

            <div class="grid grid-cols-5 gap-2 font-bold text-sm text-gray-700 mb-2 border-b-2 pb-2">
                <div>Nickname</div>
                <div>UID (Partial)</div>
                <div>Status</div>
                <div>Expires</div>
                <div>Actions</div>
            </div>
            
            <div id="admin-users-list" class="flex-grow overflow-y-auto space-y-1">
                <p class="text-gray-500 text-center py-4">Loading user list...</p>
            </div>

            <button onclick="toggleAdminModal(false)" class="mt-4 bg-gray-500 text-white font-bold py-2 rounded-lg hover:bg-gray-600 transition">Close Admin Panel</button>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, where, increment, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration and Initialization (MANDATORY GLOBALS)
        // FIX 1: Read variables from the injected 'window' object, which Netlify creates.
        const appId = typeof window.__app_id !== 'undefined' ?
        window.__app_id : 'default-app-id';

        // CORRECTED FIREBASE CONFIGURATION LINE (FIXES NETLIFY NAMING CONFLICT):
        const firebaseConfig = (typeof window.NETLIFY_FIREBASE_CONFIG !== 'undefined' ? window.NETLIFY_FIREBASE_CONFIG : window.__firebase_config) || null;
        // -------------------------------------------------------------------------
        // FIX 2: Corrected the ReferenceError (using window.__initialAuthToken)
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null; 

        const GEMINI_API_KEY = typeof window.GEMINI_API_KEY !== 'undefined' ? window.GEMINI_API_KEY : '';
        
        // --- ADMIN SECURITY CONFIGURATION (CRUCIAL) ---
        const ADMIN_USER_ID = "05806734626095127961";
        // --- END ADMIN CONFIG ---

        // --- GLOBAL ERROR HANDLER ---
        window.addEventListener('error', function(event) {
            console.error('*** Global Error Handler Caught Exception ***');
            console.error('Error Message:', event.message);
            
            if (event.target && event.target.tagName) {
                const tag = event.target.tagName.toLowerCase();
                if (tag === 'script' || tag === 'link' || tag === 'img' || event.message.includes('404')) {
                    console.error('Source causing 404-like error:', event.target.src || event.target.href || 'Unknown Source');
                }
            }
        });

        // --- TTS LONG MOTIVATIONAL SPEECH (Used by Zeus) ---
        const LONG_MOTIVATIONAL_SPEECH = "Champions rise and fall not on game day, but in the relentless, grinding hours of preparation. This is the truth of the arena. Every repetition, every drop of sweat, every moment of self-doubt conquered builds the fortress of your dominance. The clock is ticking on yesterday's efforts, and today demands more. Today, the world is watching, waiting for the thunder of your excellence. Do not give them average. Give them relentless. Give them legendary. You have the heart of a champion, the spirit of St. Louis, and the will of Zeus. Now, go seize your moment! The legacy is yours for the taking. Remember why you started this journey and finish the fight. You are the exclusive few. You are the best of Missouri. Finish strong, finish loud, and leave no doubt! You are the final countdown to victory, make this moment count!";
        
        // --- ZEUS RANDOM PHRASES & SCHOOL MASCOT ICONS ---
        const ZEUS_PHRASES = [
            "Great choice! Now you're cooking.", "Big time! Let's get that data recorded.", "Zeus approves! The hub gets stronger.", "That's how champions move. Data collected.", 
            "Strike hard! Mission accomplished.", "A move worthy of the Thunder God! Excellent.", "Feel the lightning! You're making history.", "Unstoppable! Carry on, champion.",
            "A stroke of genius! The Gods demand excellence.", "By Olympus! That data is gold.", "Feel the force of the Thunder God! Progress secured.", "The lightning never misses. Great input.",
            "That's a championship move, right there!", "Lock it in! Focus and finish.", "Level up the whole damn team! Fantastic work.", "We call that dominance! Keep the scores coming.",
            "BOOM! Data locked.", "Money time! Solid effort.", "All business. Move quick.", "Executed! Nothing else matters.",
            "Your command is absolute! Proceeding with access.", 
            "Account secured. Let the games begin!" 
        ];
        function getRandomPhrase() { return ZEUS_PHRASES[Math.floor(Math.random() * ZEUS_PHRASES.length)]; }
        
        const SCHOOL_ICONS = { "VASHON": "üê∫", "SUMNER": "üê∂", "SOLDAN": "üêÖ", "MCKINLEY": "üêû", "ROOSEVELT": "üêé", "LADUE": "üêè", 
            "KIRKWOOD": "üèà", "WEBSTER": "Statesman", "SLUH": "‚öîÔ∏è", "WHITFIELD": "üõ°Ô∏è", "LSW": "ü¶Å", "BLUESPRINGS": "üêæ", 
            "ROCKHURST": "ü¶Ö", "HICKMAN": "üêâ", "ROCKBRIDGE": "üêª", "KICKAPOO": "‚öîÔ∏è", "GLENDALE": "Falcon", "OTHER": "üèÜ"
        };

        // --- WEB AUDIO API SETUP / TTS FUNCTIONALITY ---
        let audioContext; 

        function createNoiseSource(volume) {
            const bufferSize = 2 * (audioContext?.sampleRate || 44100);
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1; 
            }

            const source = audioContext.createBufferSource();
            source.buffer = noiseBuffer;
            source.loop = true;

            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;

            source.connect(gainNode);
            return { source, gainNode };
        }

        function stopSFX(thunderSource, cheerSource, cheerGain) {
            if (thunderSource) {
                try { thunderSource.stop(); } catch(e) {}
            }
            if (cheerSource) {
                // Ramping down helps avoid hard clicks when stopping
                if (cheerGain) {
                    cheerGain.gain.setValueAtTime(cheerGain.gain.value, audioContext.currentTime);
                    cheerGain.gain.linearRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                    setTimeout(() => { 
                        try { cheerSource.stop(); } catch(e) {}
                        try { cheerGain.disconnect(); } catch(e) {}
                    }, 100);
                } else {
                    try { cheerSource.stop(); } catch(e) {}
                }
            }
        }

        // --- Core Initialization Variables and Setup ---
        window.app = null;
        window.db = null;
        window.auth = null;
        window.serverTimestamp = null;
        window.currentUserId = null;
        window.isLoggedIn = false;
        window.isPremium = false; 
        window.nickname = 'Guest';
        window.dbRef = {}; 

        if (!firebaseConfig) { 
            console.error("Firebase config not found. The app will not function.");
            document.getElementById('debug-firebase-config').querySelector('span').classList.replace('text-yellow-400', 'text-red-500');
            document.getElementById('debug-firebase-config').querySelector('span').innerText = 'MISSING';
        } else {
            setLogLevel('Debug');
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            window.serverTimestamp = serverTimestamp;

            window.chatMode = 'public'; 
            window.recipientId = '';
            window.sportsDataFilter = 'ALL';
            window.sidebarMode = 'ACTIVE'; 
            window.streamTab = 'HS_COLLEGE'; 
            window.lockerMediaCount = 0;
            
            document.getElementById('debug-firebase-config').querySelector('span').classList.replace('text-yellow-400', 'text-green-500');
            document.getElementById('debug-firebase-config').querySelector('span').innerText = 'LOADED';
            document.getElementById('debug-app-id').querySelector('span').classList.replace('text-yellow-400', 'text-green-500');
            document.getElementById('debug-app-id').querySelector('span').innerText = appId.substring(0, 10) + '...';
        }
        
        // Initialize QR Code for CashApp Modal (Done only once)
        new QRCode(document.getElementById("cashapp-qrcode"), {
            text: "$Mac100dime",
            width: 180,
            height: 180,
            colorDark : "#0047AB", // Metro Primary
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        // --- TTS API IMPLEMENTATION (CRITICAL FIX APPLIED HERE) ---
        window.generateAndSpeak = async function(speechText) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const textInput = document.getElementById('tts-input');
            const text = speechText || textInput.value.trim();
            const btn = document.getElementById('tts-button');
            const statusDisplay = document.getElementById('tts-status');
            
            if (!text) return;

            if (!GEMINI_API_KEY) {
                alert("TTS Error: Gemini API Key is missing. Check Netlify Environment Variables.");
                return;
            }

            btn.disabled = true;
            btn.innerText = 'Analyzing...';
            statusDisplay.innerText = 'Status: Fetching audio from Gemini...';

            let thunderSource = null, cheerSource = null, cheerGain = null;
            const startTime = audioContext.currentTime;
            let audio = null; // Decoded audio buffer
            let source = null; // The AudioBufferSourceNode for the TTS

            try {
                // 1. Start SFX (Background sound while waiting/speaking)
                thunderSource = createNoiseSource(0.02).source;
                cheerSource = createNoiseSource(0.01).source;
                cheerGain = audioContext.createGain();
                cheerSource.connect(cheerGain).connect(audioContext.destination);
                thunderSource.start(startTime);
                cheerSource.start(startTime);


                // 2. Send request to mock external TTS service (Replace with real Gemini API if available)
                // NOTE: This fetch uses a placeholder URL. A real Gemini endpoint would be required.
                const mockFetchResponse = await fetch('https://httpbin.org/bytes/50000', { // Using a mock endpoint that returns binary data
                    method: 'GET',
                });
                
                // Simulate a delay for the API call
                await new Promise(r => setTimeout(r, 1500)); 

                if (!mockFetchResponse.ok) {
                    throw new Error(`HTTP error! status: ${mockFetchResponse.status}`);
                }

                const audioData = await mockFetchResponse.arrayBuffer();
                
                statusDisplay.innerText = 'Status: Decoding and playing audio...';
                btn.innerText = 'Speaking...';
                
                // 3. Decode the audio data
                // NOTE: In a real app, 'audioData' would be a real mp3/wav buffer. This will fail on the mock data.
                // We wrap this in a try-catch for robustness in a real implementation.
                audio = await audioContext.decodeAudioData(audioData).catch(e => {
                    console.warn("Decode failed (expected with mock data):", e);
                    // Create a silent buffer to simulate success for the flow
                    const silentBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 4, audioContext.sampleRate);
                    return silentBuffer; 
                });

                // 4. Create the source and play the audio
                source = audioContext.createBufferSource();
                source.buffer = audio;
                source.connect(audioContext.destination);
                
                const speechDuration = audio.duration || 4.0; // Use mock duration if decode failed

                // Define the cleanup function to run after the audio ends
                const cleanupAndReset = () => {
                    stopSFX(thunderSource, cheerSource, cheerGain);
                    btn.disabled = false;
                    btn.innerText = 'Announce Now!';
                    statusDisplay.innerText = 'Status: Requires Gemini API Key';
                    if (textInput) textInput.value = '';
                };

                // CRITICAL FIX: Set the cleanup to run *after* the TTS audio has finished playing
                source.onended = cleanupAndReset; 

                // 5. Start the TTS playback
                source.start(0);

                // SFX volume ramp up/down during speech for dramatic effect
                const fadeDuration = 0.5; // seconds
                
                cheerGain.gain.setValueAtTime(0.01, audioContext.currentTime);
                cheerGain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1); // Quick cheer increase
                
                // Keep high throughout speech
                if (speechDuration > 0.5) {
                    cheerGain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + speechDuration - fadeDuration);
                }
                
                // Final ramp down to match the end of the TTS audio
                cheerGain.gain.linearRampToValueAtTime(0.01, audioContext.currentTime + speechDuration);


            } catch (error) {
                console.error("TTS GENERATION/DECODE ERROR:", error);
                alert(`TTS failed: ${error.message}. Check console for details. (Note: Mock API/Key is likely the cause)`);

                // Ensure button and SFX are reset even on failure
                stopSFX(thunderSource, cheerSource, cheerGain); 
                btn.disabled = false;
                btn.innerText = 'Announce Now!';
                statusDisplay.innerText = 'Status: TTS Error';
            }
        }
        
        // --- AUTHENTICATION FUNCTIONS (MANDATORY) ---
        
        window.toggleLoginModal = function(show) {
            document.getElementById('login-modal').classList.toggle('hidden', !show);
            if (show) {
                // Generate unique ID for QR login on modal open
                const uid = Math.random().toString(36).substring(2) + Date.now().toString(36);
                document.getElementById('login-qr-id-input').value = uid;
                document.getElementById('login-qrcode').innerHTML = '';
                new QRCode(document.getElementById("login-qrcode"), {
                    text: uid,
                    width: 100,
                    height: 100,
                    colorDark : "#0047AB",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            }
        }
        
        window.toggleAccountModal = function(show) {
            document.getElementById('account-modal').classList.toggle('hidden', !show);
            if (show && window.auth.currentUser) {
                const user = window.auth.currentUser;
                document.getElementById('account-uid').innerText = user.uid.substring(0, 12) + '...';
                document.getElementById('account-premium-status').innerText = window.isPremium ? 'PRO MEMBER üéâ' : 'BASIC';
                document.getElementById('account-nickname').value = window.nickname;
            }
        }

        window.logIn = async function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.innerText = '';
            
            try {
                await signInWithEmailAndPassword(window.auth, email, password);
                toggleLoginModal(false);
            } catch (error) {
                console.error("Login Error:", error);
                errorEl.innerText = error.message.replace('Firebase: ', '');
            }
        }

        window.register = async function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.innerText = '';
            
            try {
                const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
                
                // Initialize user profile in Firestore
                const userDocRef = doc(window.db, "users", userCredential.user.uid);
                await setDoc(userDocRef, {
                    uid: userCredential.user.uid,
                    nickname: 'NewPlayer_' + userCredential.user.uid.substring(0, 5),
                    premium: false,
                    contributions: 0,
                    lastLogin: serverTimestamp(),
                    isAdmin: false
                });
                
                alert("Registration successful! Welcome to the hub.");
                toggleLoginModal(false);
            } catch (error) {
                console.error("Registration Error:", error);
                errorEl.innerText = error.message.replace('Firebase: ', '');
            }
        }
        
        window.logOut = function() {
            signOut(window.auth).catch(error => {
                console.error("Logout Error:", error);
                alert("Logout failed. Check console.");
            });
        }
        
        window.saveAccountNickname = async function() {
            if (!window.currentUserId) return;
            const newNickname = document.getElementById('account-nickname').value.trim();
            if (newNickname.length < 3) {
                alert("Nickname must be at least 3 characters.");
                return;
            }
            try {
                const userDocRef = doc(window.db, "users", window.currentUserId);
                await updateDoc(userDocRef, { nickname: newNickname });
                window.nickname = newNickname; // Update local state immediately
                alert("Nickname updated successfully!");
            } catch (error) {
                console.error("Save Nickname Error:", error);
                alert("Failed to save nickname.");
            }
        }

        window.updateUserPassword = async function() {
            const newPassword = document.getElementById('account-new-password').value;
            const errorEl = document.getElementById('account-password-error');
            errorEl.innerText = '';

            if (newPassword.length < 6) {
                errorEl.innerText = 'Password must be at least 6 characters.';
                return;
            }

            try {
                await updatePassword(window.auth.currentUser, newPassword);
                errorEl.innerText = 'Password updated successfully! Please re-login.';
                errorEl.classList.replace('text-red-500', 'text-green-500');
                // Force logout to apply new password
                setTimeout(() => logOut(), 2000); 
            } catch (error) {
                console.error("Update Password Error:", error);
                errorEl.innerText = error.message.replace('Firebase: ', '');
                errorEl.classList.replace('text-green-500', 'text-red-500');
            }
        }
        
        // --- PAYWALL/PREMIUM FUNCTIONS ---
        window.toggleCashAppModal = function(show) {
             document.getElementById('cashapp-modal').classList.toggle('hidden', !show);
        }
        
        window.simulatePaymentSuccess = function() {
            if (!window.currentUserId) {
                alert("You must be logged in to upgrade.");
                return;
            }
            toggleCashAppModal(false);
            
            // Simulate 1 year upgrade
            window.upgradeToPremiumForOneYear();
        }

        window.upgradeToPremiumForOneYear = async function() {
            if (!window.currentUserId) return;
            
            const oneYearFromNow = new Date();
            oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
            
            try {
                 const userDocRef = doc(window.db, "users", window.currentUserId);
                 await updateDoc(userDocRef, {
                    premium: true,
                    premiumExpiry: oneYearFromNow.getTime(),
                    contributions: increment(10) // Bonus points for upgrading
                 });
                 window.isPremium = true; // Update local state
                 checkAccess(); // Re-check access immediately
                 
                 // Launch Zeus with a motivational phrase
                 startZeusNarratorTour(getRandomPhrase());
            } catch (error) {
                console.error("Upgrade Error:", error);
                alert("Failed to simulate upgrade.");
            }
        }

        // --- DATA SUBMISSION AND CHAT FUNCTIONS ---
        window.toggleSportsDataModal = function(show) {
            document.getElementById('sports-data-modal').classList.toggle('hidden', !show);
        }

        window.submitSportsData = async function() {
            if (!window.isLoggedIn) {
                alert("You must be logged in to submit data.");
                return;
            }
            
            const type = document.getElementById('data-type').value;
            const school = document.getElementById('data-school').value;
            const title = document.getElementById('data-title').value.trim();
            const details = document.getElementById('data-details').value.trim();
            const videoUrl = document.getElementById('data-video-url').value.trim();

            if (!title || !details) {
                alert("Title and details are required.");
                return;
            }

            try {
                await addDoc(collection(window.db, "sportsData"), {
                    type: type,
                    school: school,
                    title: title,
                    details: details,
                    videoUrl: videoUrl,
                    submittedBy: window.nickname,
                    submittedById: window.currentUserId,
                    timestamp: serverTimestamp(),
                    upvotes: 0
                });

                // Increment user contribution score
                const userDocRef = doc(window.db, "users", window.currentUserId);
                await updateDoc(userDocRef, { contributions: increment(5) });

                toggleSportsDataModal(false);
                alert(getRandomPhrase());
            } catch (error) {
                console.error("Submit Data Error:", error);
                alert("Failed to submit data.");
            }
        }
        
        window.toggleChatMode = function() {
            const mode = document.getElementById('chat-mode-toggle').value;
            window.chatMode = mode;
            const recipientInput = document.getElementById('recipient-id-input');
            const recipientContainer = document.getElementById('recipient-container');
            const videoBtn = document.getElementById('video-call-btn');

            if (mode === 'private') {
                recipientInput.classList.remove('hidden');
                recipientInput.oninput = function() {
                    const id = this.value.trim();
                    window.recipientId = id;
                    document.getElementById('recipient-display').innerText = `Sending PM to: ${id.substring(0, 10)}...`;
                    recipientContainer.classList.toggle('hidden', id.length < 10);
                    videoBtn.classList.toggle('hidden', id.length < 10);
                };
            } else {
                recipientInput.classList.add('hidden');
                recipientContainer.classList.add('hidden');
                videoBtn.classList.add('hidden');
                window.recipientId = '';
            }
        }
        
        window.sendMessage = async function(type, forcedMessage) {
            if (!window.isLoggedIn || !window.isPremium) {
                alert("You must be a PRO MEMBER to use the chat.");
                return;
            }

            const input = document.getElementById('message-input');
            const message = forcedMessage || input.value.trim();
            const isPrivate = window.chatMode === 'private';
            const recipientId = window.recipientId;

            if (!message || (isPrivate && !recipientId)) return;

            try {
                await addDoc(collection(window.db, "chatMessages"), {
                    senderId: window.currentUserId,
                    senderNickname: window.nickname,
                    message: message,
                    type: type,
                    isPrivate: isPrivate,
                    recipientId: isPrivate ? recipientId : null,
                    timestamp: serverTimestamp()
                });

                input.value = ''; // Clear input on success
            } catch (error) {
                console.error("Send Message Error:", error);
                alert("Failed to send message.");
            }
        }

        window.toggleSidebarMode = function(mode) {
            window.sidebarMode = mode;
            document.getElementById('active-users-list').classList.toggle('hidden', mode !== 'ACTIVE');
            document.getElementById('leaderboard-list').classList.toggle('hidden', mode !== 'LEADERBOARD');
            
            document.getElementById('mode-active-btn').classList.toggle('bg-metro-primary', mode === 'ACTIVE');
            document.getElementById('mode-active-btn').classList.toggle('text-white', mode === 'ACTIVE');
            document.getElementById('mode-active-btn').classList.toggle('bg-gray-200', mode !== 'ACTIVE');
            document.getElementById('mode-active-btn').classList.toggle('text-gray-700', mode !== 'ACTIVE');
            
            document.getElementById('mode-leaderboard-btn').classList.toggle('bg-metro-primary', mode === 'LEADERBOARD');
            document.getElementById('mode-leaderboard-btn').classList.toggle('text-white', mode === 'LEADERBOARD');
            document.getElementById('mode-leaderboard-btn').classList.toggle('bg-gray-200', mode !== 'LEADERBOARD');
            document.getElementById('mode-leaderboard-btn').classList.toggle('text-gray-700', mode !== 'LEADERBOARD');
        }

        // --- ADMIN/DEBUG FUNCTIONS ---
        window.toggleAdminModal = function(show) {
            if (window.isLoggedIn && window.isAdmin) {
                document.getElementById('admin-modal').classList.toggle('hidden', !show);
                if (show) listenForAdminUsers();
            } else {
                alert("Access Denied. Admin privileges required.");
            }
        }
        
        window.copyQrCodeText = function() {
            const qrText = document.getElementById('login-qr-id-input').value;
            navigator.clipboard.writeText(qrText).then(() => {
                alert("User ID copied to clipboard!");
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        }
        
        // --- ZEUS NARRATOR/FLIGHT FUNCTIONS ---
        window.flyZeusAndClick = function(buttonId, callback, duration) {
            const targetButton = document.getElementById(buttonId);
            const zeusSvg = document.getElementById('zeus-avatar-svg');
            
            if (!targetButton || !zeusSvg) {
                callback(); // Fallback if elements not found
                return;
            }

            // 1. Get positions
            const targetRect = targetButton.getBoundingClientRect();
            const startX = window.innerWidth - 40;
            const startY = window.innerHeight - 40;
            const targetX = targetRect.left + (targetRect.width / 2) - 20;
            const targetY = targetRect.top + (targetRect.height / 2) - 20;

            // 2. Prepare Zeus SVG
            zeusSvg.classList.add('flying-zeus');
            zeusSvg.style.transitionDuration = `${duration}ms`;
            zeusSvg.style.transform = `translateY(${startY - targetY}px) translateX(${startX - targetX}px)`;
            zeusSvg.style.opacity = 1;

            // 3. Move Zeus
            requestAnimationFrame(() => {
                zeusSvg.style.transform = `translateY(0) translateX(0)`;
                
                // 4. Execute callback after flight duration
                setTimeout(() => {
                    zeusSvg.style.opacity = 0;
                    zeusSvg.style.transform = ''; // Reset transform
                    zeusSvg.classList.remove('flying-zeus');
                    
                    // The main action
                    callback();
                    
                    // Re-position Zeus to bottom-right (original CSS)
                    setTimeout(() => {
                        zeusSvg.style.opacity = window.isPremium ? 1 : 0;
                    }, 500); 

                }, duration);
            });
        }

        window.startZeusNarratorTour = function(customText = LONG_MOTIVATIONAL_SPEECH) {
            if (!window.isPremium) {
                // If not premium, just show a motivational message visually
                document.getElementById('status-message').innerText = "PRO Member Feature: Launch Zeus Tour! Upgrade now to hear the full message.";
                document.getElementById('status-message-container').classList.remove('hidden');
                setTimeout(() => document.getElementById('status-message-container').classList.add('hidden'), 5000);
                return;
            }

            // Fly Zeus to the TTS button area
            flyZeusAndClick('tts-button', () => {
                // Execute the TTS function with the custom text after Zeus arrives
                window.generateAndSpeak(customText);
            }, 1200);
        }

        // --- FIREBASE LISTENERS (PLACEHOLDERS) ---
        
        function checkAccess() {
            const mainContent = document.getElementById('main-content');
            const paywall = document.getElementById('paywall-content');
            const chatHeading = document.getElementById('chat-heading');
            const lockerHeading = document.getElementById('locker-heading');
            const narratorBtn = document.getElementById('narrator-launch-btn');
            const ttsButton = document.getElementById('tts-button');

            if (window.isPremium) {
                mainContent.classList.remove('hidden');
                paywall.classList.add('hidden');
                chatHeading.innerText = 'Team Chat (Active)';
                lockerHeading.innerText = 'Personal Media Locker (Unlimited PRO)';
                narratorBtn.classList.remove('hidden');
                ttsButton.disabled = !GEMINI_API_KEY; // Enable if key is present
                document.getElementById('zeus-avatar-svg').style.opacity = 1;
            } else {
                mainContent.classList.add('hidden');
                paywall.classList.remove('hidden');
                chatHeading.innerText = 'Team Chat (PRO Members Only)';
                lockerHeading.innerText = 'Personal Media Locker (Basic - 1 File)';
                narratorBtn.classList.add('hidden');
                ttsButton.disabled = true;
                document.getElementById('zeus-avatar-svg').style.opacity = 0;
            }
            
            // Check admin status
            document.getElementById('admin-btn').classList.toggle('hidden', !window.isAdmin);
        }

        function setupUserPresence(uid) {
            if (!window.db) return;
            // A simple implementation of user presence (active users list)
            const presenceRef = doc(window.db, "presence", uid);
            const lastActive = Date.now();
            
            setDoc(presenceRef, { 
                uid: uid, 
                nickname: window.nickname, 
                lastActive: lastActive, 
                isPremium: window.isPremium,
                isAdmin: window.isAdmin
            }, { merge: true });

            // Set up a listener for active users
            onSnapshot(collection(window.db, "presence"), (snapshot) => {
                const activeUsersList = document.getElementById('active-users-list');
                activeUsersList.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const statusClass = data.isPremium ? 'text-yellow-600' : 'text-green-600';
                    const icon = data.isAdmin ? 'üëë' : (data.isPremium ? '‚≠ê' : 'üü¢');
                    activeUsersList.innerHTML += `<div class="flex justify-between items-center text-sm"><span class="${statusClass}">${icon} ${data.nickname}</span><span class="text-xs text-gray-500">${new Date(data.lastActive).toLocaleTimeString()}</span></div>`;
                });
            });
        }
        
        function listenForRealTimeData() {
            if (!window.db) return;
            const dataStreamEl = document.getElementById('data-stream');
            
            // Listen to a 'liveData' document
            const docRef = doc(window.db, "liveFeed", "latestScore");
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    dataStreamEl.innerText = JSON.stringify(data, null, 2);
                    document.getElementById('latest-data').innerText = `Last Update: ${new Date(data.timestamp.toDate()).toLocaleTimeString()}`;
                    document.getElementById('last-activity').innerText = new Date(data.timestamp.toDate()).toLocaleTimeString();
                } else {
                    dataStreamEl.innerText = "No real-time data found.";
                }
            }, (error) => {
                console.error("Error listening to live data:", error);
            });
        }
        
        function listenForChatMessages() {
            if (!window.db) return;
            const chatEl = document.getElementById('chat-messages');
            
            const q = query(collection(window.db, "chatMessages"), orderBy("timestamp", "desc"), limit(50));
            
            onSnapshot(q, (snapshot) => {
                chatEl.innerHTML = '';
                const messages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Filter for private messages
                    const isRelevantPrivate = data.isPrivate && (data.recipientId === window.currentUserId || data.senderId === window.currentUserId);
                    const isPublic = !data.isPrivate;
                    
                    if (isPublic || isRelevantPrivate) {
                        const style = data.isPrivate ? 'bg-yellow-200 text-yellow-900 border-l-4 border-yellow-500 p-2 rounded-lg' : 
                                      (data.senderId === window.currentUserId ? 'bg-metro-primary text-white ml-auto p-2 rounded-lg max-w-[80%]' : 'bg-white shadow-sm p-2 rounded-lg max-w-[80%]');
                        const prefix = data.isPrivate ? '[PM] ' : (data.type === 'VIDEO_REQUEST' ? 'üìπ CALL REQUEST: ' : '');
                        const senderName = data.senderId === window.currentUserId ? 'You' : data.senderNickname;
                        
                        messages.push(`
                            <div class="${style}">
                                <span class="font-bold text-xs block">${prefix}${senderName}</span>
                                <p class="text-sm">${data.message}</p>
                            </div>
                        `);
                    }
                });
                
                chatEl.innerHTML = messages.reverse().join(''); // Reverse to show latest at bottom
                chatEl.scrollTop = chatEl.scrollHeight; // Scroll to bottom
            }, (error) => {
                chatEl.innerHTML = `<p class="text-center text-red-500">Error loading chat: ${error.message}</p>`;
                console.error("Error listening to chat:", error);
            });
        }

        function listenForSportsData() {
            if (!window.db) return;
            const dataDisplayEl = document.getElementById('sports-data-display');
            
            const q = query(collection(window.db, "sportsData"), orderBy("timestamp", "desc"), limit(10));
            
            onSnapshot(q, (snapshot) => {
                dataDisplayEl.innerHTML = '';
                if (snapshot.empty) {
                    dataDisplayEl.innerHTML = '<p class="text-center text-gray-500 py-8 col-span-full">No submitted sports data yet.</p>';
                    return;
                }
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const icon = SCHOOL_ICONS[data.school] || SCHOOL_ICONS['OTHER'];
                    dataDisplayEl.innerHTML += `
                        <div class="bg-white p-4 rounded-lg shadow-md card border-l-4 border-metro-accent">
                            <div class="flex justify-between items-start">
                                <h4 class="text-lg font-semibold text-gray-800">${icon} ${data.title}</h4>
                                <span class="text-xs font-medium text-gray-500">${data.type}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${data.details}</p>
                            <p class="text-xs text-gray-500 mt-2">Submitted by: ${data.submittedBy} at ${new Date(data.timestamp.toDate()).toLocaleTimeString()}</p>
                        </div>
                    `;
                });
            }, (error) => {
                dataDisplayEl.innerHTML = `<p class="text-center text-red-500 py-8 col-span-full">Error loading scoreboard data: ${error.message}</p>`;
                console.error("Error listening to sports data:", error);
            });
        }
        
        function listenForLeaderboard() {
            if (!window.db) return;
            const leaderboardEl = document.getElementById('leaderboard-list');
            
            const q = query(collection(window.db, "users"), orderBy("contributions", "desc"), limit(10));
            
            onSnapshot(q, (snapshot) => {
                leaderboardEl.innerHTML = '';
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const rank = index + 1;
                    const rankIcon = rank === 1 ? 'ü•á' : (rank === 2 ? 'ü•à' : (rank === 3 ? 'ü•â' : `#${rank}`));
                    const premiumIcon = data.premium ? '‚≠ê' : '';
                    leaderboardEl.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-1 rounded-md hover:bg-gray-100">
                            <span class="font-bold">${rankIcon} ${data.nickname} ${premiumIcon}</span>
                            <span class="text-metro-accent font-mono">${data.contributions} pts</span>
                        </div>
                    `;
                });
            });
        }
        
        function listenForAdminUsers() {
             if (!window.db || !window.isAdmin) return;
             const adminListEl = document.getElementById('admin-users-list');
             
             onSnapshot(collection(window.db, "users"), (snapshot) => {
                adminListEl.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const status = data.premium ? 'PRO' : 'Basic';
                    const expires = data.premiumExpiry ? new Date(data.premiumExpiry).toLocaleDateString() : 'N/A';
                    const uidPartial = data.uid.substring(0, 8);
                    
                    adminListEl.innerHTML += `
                        <div class="grid grid-cols-5 gap-2 text-xs py-2 border-b border-gray-100 items-center hover:bg-red-50">
                            <div class="font-medium">${data.nickname}</div>
                            <div class="font-mono">${uidPartial}...</div>
                            <div class="${data.premium ? 'text-green-600 font-semibold' : 'text-gray-500'}">${status}</div>
                            <div class="${data.premium ? 'text-green-500' : 'text-gray-400'}">${expires}</div>
                            <div>
                                <button onclick="setAdmin('${data.uid}', ${!data.isAdmin})" class="text-red-500 hover:text-red-700 text-xs">${data.isAdmin ? 'Revoke Admin' : 'Grant Admin'}</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.setAdmin = async function(uid, isAdmin) {
            if (!window.isAdmin || uid === ADMIN_USER_ID) {
                alert("Cannot modify this user or self-admin status.");
                return;
            }
             try {
                const userDocRef = doc(window.db, "users", uid);
                await updateDoc(userDocRef, { isAdmin: isAdmin });
                alert(`User ${uid.substring(0, 5)}... admin status set to ${isAdmin}.`);
            } catch (error) {
                console.error("Admin Update Error:", error);
            }
        }

        // --- AUTH STATE & INIT ---
        if (window.db) {
            onAuthStateChanged(window.auth, async (user) => {
                const headerAuthBtn = document.getElementById('header-auth-btn');
                const accountBtn = document.getElementById('account-btn');
                const userIdDisplay = document.getElementById('user-id-display');
                const statusDisplay = document.getElementById('user-status-display');
                const ttsButton = document.getElementById('tts-button');

                if (user) {
                    window.isLoggedIn = true;
                    window.currentUserId = user.uid;
                    
                    // Fetch user profile from Firestore
                    const userDocRef = doc(window.db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        window.nickname = userData.nickname || 'Player_' + user.uid.substring(0, 5);
                        window.isPremium = userData.premium || false;
                        window.isAdmin = userData.isAdmin || false;
                        
                        // Check expiry
                        if (window.isPremium && userData.premiumExpiry && userData.premiumExpiry < Date.now()) {
                            // Membership expired
                            await updateDoc(userDocRef, { premium: false });
                            window.isPremium = false;
                        }

                    } else {
                        // Create basic profile if missing (should be done on register, but safe fallback)
                        await setDoc(userDocRef, { 
                            uid: user.uid, 
                            nickname: 'Player_' + user.uid.substring(0, 5), 
                            premium: false,
                            contributions: 0,
                            isAdmin: false
                        });
                        window.nickname = 'Player_' + user.uid.substring(0, 5);
                        window.isPremium = false;
                        window.isAdmin = false;
                    }
                    
                    statusDisplay.innerText = `Logged in as: ${window.nickname}`;
                    userIdDisplay.innerText = user.uid.substring(0, 10);
                    headerAuthBtn.classList.add('hidden');
                    accountBtn.classList.remove('hidden');
                    ttsButton.disabled = !GEMINI_API_KEY || !window.isPremium;
                    
                    // Start real-time listeners only when logged in
                    listenForRealTimeData();
                    listenForSportsData();
                    listenForChatMessages();
                    listenForLeaderboard();
                    setupUserPresence(user.uid);
                    
                } else {
                    // Logged Out State
                    window.isLoggedIn = false;
                    window.currentUserId = null;
                    window.isPremium = false;
                    window.isAdmin = false;
                    window.nickname = 'Guest';
                    
                    statusDisplay.innerText = 'Logged Out';
                    userIdDisplay.innerText = 'N/A';
                    headerAuthBtn.classList.remove('hidden');
                    accountBtn.classList.add('hidden');
                    ttsButton.disabled = true;
                }
                
                checkAccess();
                document.getElementById('loading-overlay').classList.add('hidden');
            });
        }
        
        // Initial token check (for silent/automatic login)
        if (window.auth && initialAuthToken) {
            document.getElementById('debug-auth-token').querySelector('span').classList.replace('text-yellow-400', 'text-green-500');
            document.getElementById('debug-auth-token').querySelector('span').innerText = 'PRESENT';
            signInWithCustomToken(window.auth, initialAuthToken).catch(error => {
                console.error("Custom Token Login Failed:", error);
                document.getElementById('debug-auth-token').querySelector('span').classList.replace('text-green-500', 'text-red-500');
                document.getElementById('debug-auth-token').querySelector('span').innerText = 'FAILED';
            });
        } else {
            document.getElementById('debug-auth-token').querySelector('span').innerText = 'N/A';
            document.getElementById('loading-overlay').classList.add('hidden'); // Hide overlay if no token to check
        }
    </script>
</body>
</html>
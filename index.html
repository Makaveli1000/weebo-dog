// Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, where, increment, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration and Initialization (MANDATORY GLOBALS)
        const appId = typeof window.__app_id !== 'undefined' ?
        window.__app_id : 'default-app-id';

        const firebaseConfig = (typeof window.NETLIFY_FIREBASE_CONFIG !== 'undefined' ? window.NETLIFY_FIREBASE_CONFIG : window.__firebase_config) || null;
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null; 

        const GEMINI_API_KEY = typeof window.GEMINI_API_KEY !== 'undefined' ? window.GEMINI_API_KEY : '';
        
        // --- ADMIN SECURITY CONFIGURATION ---
        const ADMIN_USER_ID = "05806734626095127961";
        // --- END ADMIN CONFIG ---

        // --- GLOBAL ERROR HANDLER ---
        window.addEventListener('error', function(event) {
            console.error('*** Global Error Handler Caught Exception ***');
            console.error('Error Message:', event.message);
            
            if (event.target && event.target.tagName) {
                const tag = event.target.tagName.toLowerCase();
                if (tag === 'script' || tag === 'link' || tag === 'img' || event.message.includes('404')) {
                    console.error('Source causing 404-like error:', event.target.src || event.target.href || 'Unknown Source');
                }
            }
        });

        // --- TTS LONG MOTIVATIONAL SPEECH (Used by Zeus) ---
        const LONG_MOTIVATIONAL_SPEECH = "Champions rise and fall not on game day, but in the relentless, grinding hours of preparation. This is the truth of the arena. Every repetition, every drop of sweat, every moment of self-doubt conquered builds the fortress of your dominance. The clock is ticking on yesterday's efforts, and today demands more. Today, the world is watching, waiting for the thunder of your excellence. Do not give them average. Give them relentless. Give them legendary. You have the heart of a champion, the spirit of St. Louis, and the will of Zeus. Now, go seize your moment! The legacy is yours for the taking. Remember why you started this journey and finish the fight. You are the exclusive few. You are the best of Missouri. Finish strong, finish loud, and leave no doubt! You are the final countdown to victory, make this moment count!";
        
        // --- ZEUS RANDOM PHRASES & SCHOOL MASCOT ICONS ---
        const ZEUS_PHRASES = [
            "Great choice! Now you're cooking.", "Big time! Let's get that data recorded.", "Zeus approves! The hub gets stronger.", "That's how champions move. Data collected.", 
            "Strike hard! Mission accomplished.", "A move worthy of the Thunder God! Excellent.", "Feel the lightning! You're making history.", "Unstoppable! Carry on, champion.",
            "A stroke of genius! The Gods demand excellence.", "By Olympus! That data is gold.", "Feel the force of the Thunder God! Progress secured.", "The lightning never misses. Great input.",
            "That's a championship move, right there!", "Lock it in! Focus and finish.", "Level up the whole damn team! Fantastic work.", "We call that dominance! Keep the scores coming.",
            "BOOM! Data locked.", "Money time! Solid effort.", "All business. Move quick.", "Executed! Nothing else matters.",
            "Your command is absolute! Proceeding with access.", 
            "Account secured. Let the games begin!" 
        ];
        function getRandomPhrase() { return ZEUS_PHRASES[Math.floor(Math.random() * ZEUS_PHRASES.length)]; }
        
        const SCHOOL_ICONS = { "VASHON": "üê∫", "SUMNER": "üê∂", "SOLDAN": "üêÖ", "MCKINLEY": "üêû", "ROOSEVELT": "üêé", "LADUE": "üêè", 
            "KIRKWOOD": "üèà", "WEBSTER": "Statesman", "SLUH": "‚öîÔ∏è", "WHITFIELD": "üõ°Ô∏è", "LSW": "ü¶Å", "BLUESPRINGS": "üêæ", 
            "ROCKHURST": "ü¶Ö", "HICKMAN": "üêâ", "ROCKBRIDGE": "üêª", "KICKAPOO": "‚öîÔ∏è", "GLENDALE": "Falcon", "OTHER": "üèÜ"
        };

        // --- WEB AUDIO API SETUP / TTS FUNCTIONALITY (Helpers) ---
        let audioContext; 

        function createNoiseSource(volume) {
            const bufferSize = 2 * (audioContext?.sampleRate || 44100);
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1; 
            }

            const source = audioContext.createBufferSource();
            source.buffer = noiseBuffer;
            source.loop = true;

            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;

            source.connect(gainNode);
            return { source, gainNode };
        }

        function stopSFX(thunderSource, cheerSource, cheerGain) {
            if (thunderSource) {
                try { thunderSource.stop(); } catch(e) {}
            }
            if (cheerSource) {
                if (cheerGain) {
                    cheerGain.gain.setValueAtTime(cheerGain.gain.value, audioContext.currentTime);
                    cheerGain.gain.linearRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                    setTimeout(() => { 
                        try { cheerSource.stop(); } catch(e) {}
                        try { cheerGain.disconnect(); } catch(e) {}
                    }, 100);
                } else {
                    try { cheerSource.stop(); } catch(e) {}
                }
            }
        }
        
        // --- UTILITY: HIDES LOADING OVERLAY (FIXED CRASH) ---
        function hideLoadingScreen() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none'; 
            }
        }
        
        // --- UTILITY: SETS UI FOR LOGGED OUT STATE ---
        function displayLoggedOutState() {
            window.isLoggedIn = false;
            window.isPremium = false;
            window.currentUserId = null;
            
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('paywall-content').classList.remove('hidden');
            
            document.getElementById('header-auth-btn').classList.remove('hidden');
            document.getElementById('account-btn').classList.add('hidden');
            document.getElementById('admin-btn').classList.add('hidden');
        }
        
        // --- UTILITY: INITIALIZES FEATURES AFTER AUTH ---
        async function initializeUserFeatures(uid, email) {
            const userDocRef = doc(window.db, `artifacts/${appId}/users/${uid}/profile/info`);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                window.nickname = userData.nickname || email.split('@')[0];
                window.isPremium = userData.isPremium || false;
                window.isAdmin = userData.isAdmin || false; 

                // PLACEHOLDER: Setup all real-time data listeners 
                setupPresenceTracking(uid);
                setupChatListener();
                setupSportsDataListener();
                setupLeaderboardListener();
                
                if (window.isPremium) {
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('paywall-content').classList.add('hidden');
                } else {
                    document.getElementById('main-content').classList.add('hidden');
                    document.getElementById('paywall-content').classList.remove('hidden');
                }
                
            } else {
                displayLoggedOutState();
            }
        }

        // --- TTS API IMPLEMENTATION (CRITICAL FIX APPLIED HERE) ---
        window.generateAndSpeak = async function(speechText) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const textInput = document.getElementById('tts-input');
            const text = speechText || textInput.value.trim();
            const btn = document.getElementById('tts-button');
            const statusDisplay = document.getElementById('tts-status');
            
            if (!text) return;
            if (!window.isPremium) {
                 alert("TTS is a PRO MEMBER feature.");
                 return;
            }

            btn.disabled = true;
            btn.innerText = 'Connecting...';
            statusDisplay.innerText = 'Status: Sending text to server...';

            let thunderSource = null, cheerSource = null, cheerGain = null;
            const startTime = audioContext.currentTime;
            let audio = null;
            let source = null;

            try {
                // 1. Start SFX
                const thunderFX = createNoiseSource(0.02);
                const cheerFX = createNoiseSource(0.01);
                thunderSource = thunderFX.source;
                cheerSource = cheerFX.source;
                cheerGain = cheerFX.gainNode;
                
                cheerSource.connect(cheerGain).connect(audioContext.destination);
                thunderSource.connect(audioContext.destination);
                
                thunderSource.start(startTime);
                cheerSource.start(startTime);
                
                btn.innerText = 'Fetching Audio...';
                statusDisplay.innerText = 'Status: Waiting for audio data...';

                // 2. Fetch the audio from the deployed Netlify serverless function
                const response = await fetch('/.netlify/functions/generate-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                
                if (!response.ok) {
                    throw new Error(`Serverless Function Error: ${response.status} ${response.statusText}`);
                }

                // 3. Decode the audio buffer
                const audioData = await response.arrayBuffer();
                
                statusDisplay.innerText = 'Status: Decoding and playing audio...';
                btn.innerText = 'Speaking...';
                
                audio = await audioContext.decodeAudioData(audioData);

                // 4. Create the source and play the audio
                source = audioContext.createBufferSource();
                source.buffer = audio;
                source.connect(audioContext.destination);
                const speechDuration = audio.duration;

                const cleanupAndReset = () => {
                    stopSFX(thunderSource, cheerSource, cheerGain);
                    btn.disabled = false;
                    btn.innerText = 'Announce Now!';
                    statusDisplay.innerText = 'Status: Ready';
                    if (textInput && speechText === undefined) textInput.value = '';
                };

                source.onended = cleanupAndReset; 

                // 5. Start the TTS playback and handle SFX volume ramp
                source.start(0);

                const fadeDuration = 0.5;
                cheerGain.gain.setValueAtTime(0.01, audioContext.currentTime);
                cheerGain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1); 
                
                if (speechDuration > fadeDuration) {
                    cheerGain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + speechDuration - fadeDuration);
                    cheerGain.gain.linearRampToValueAtTime(0.01, audioContext.currentTime + speechDuration);
                }
                
                if (thunderSource.stop) thunderSource.stop(audioContext.currentTime + 0.5); 

            } catch (error) {
                console.error("TTS GENERATION/DECODE ERROR:", error);
                alert(`TTS failed: ${error.message}. Please check server logs and Google Cloud API status.`);

                stopSFX(thunderSource, cheerSource, cheerGain); 
                btn.disabled = false;
                btn.innerText = 'Announce Now!';
                statusDisplay.innerText = 'Status: Failed';
            }
        }
        
        // ------------------------------------------------------------------------
        // PLACEHOLDER / STUB FUNCTIONS (Required by the main logic)
        // ------------------------------------------------------------------------
        
        function setupPresenceTracking(uid) { console.log("LOG: setupPresenceTracking STUB."); }
        function setupChatListener() { console.log("LOG: setupChatListener STUB."); }
        function setupSportsDataListener() { console.log("LOG: setupSportsDataListener STUB."); }
        function setupLeaderboardListener() { console.log("LOG: setupLeaderboardListener STUB."); }
        function logIn() { console.log("LOG: logIn STUB."); }
        function register() { console.log("LOG: register STUB."); }
        function logOut() { console.log("LOG: logOut STUB."); }
        function saveAccountNickname() { console.log("LOG: saveAccountNickname STUB."); }
        function updateUserPassword() { console.log("LOG: updateUserPassword STUB."); }
        function handleFileUpload() { console.log("LOG: handleFileUpload STUB."); }
        function submitSportsData() { console.log("LOG: submitSportsData STUB."); }
        function toggleChatMode() { console.log("LOG: toggleChatMode STUB."); }
        function toggleSidebarMode() { console.log("LOG: toggleSidebarMode STUB."); }
        function startZeusNarratorTour() { console.log("LOG: startZeusNarratorTour STUB."); }
        function flyZeusAndClick(buttonId, callback, duration) { if (typeof callback === 'function') callback(); }
        function toggleAdminModal() { console.log("LOG: toggleAdminModal STUB."); }
        function toggleCashAppModal() { console.log("LOG: toggleCashAppModal STUB."); }
        function toggleSportsDataModal() { console.log("LOG: toggleSportsDataModal STUB."); }
        
        // ------------------------------------------------------------------------
        
        // --- FINAL APP STARTUP LOGIC ---
        
        // Core Initialization Variables and Setup
        window.app = null;
        window.db = null;
        window.auth = null;
        window.serverTimestamp = null;
        window.currentUserId = null;
        window.isLoggedIn = false;
        window.isPremium = false; 
        window.nickname = 'Guest';
        window.dbRef = {}; 

        if (!firebaseConfig) { 
            console.error("Firebase config not found. The app will not function.");
            document.getElementById('debug-firebase-config').querySelector('span').classList.replace('text-yellow-400', 'text-red-500');
            document.getElementById('debug-firebase-config').querySelector('span').innerText = 'MISSING';
            hideLoadingScreen(); 
        } else {
            setLogLevel('Debug');
            // 1. INITIALIZE FIREBASE APP AND SERVICES
            window.app = initializeApp(firebaseConfig); 
            window.auth = getAuth(window.app);
            window.db = getFirestore(window.app);
            window.serverTimestamp = serverTimestamp;

            // 2. DIAGNOSTIC: SKIPPING CUSTOM TOKEN LOGIN (Logic is handled by onAuthStateChanged)
            if (initialAuthToken) {
                console.warn('DIAGNOSTIC ACTIVE: Skipping automatic custom token login to check app startup.');
            } 
            
            // Update debug display for config
            document.getElementById('debug-firebase-config').querySelector('span').classList.replace('text-yellow-400', 'text-green-500');
            document.getElementById('debug-firebase-config').querySelector('span').innerText = 'OK (API Key ending in ' + firebaseConfig.apiKey.slice(-4) + ')';
            document.getElementById('debug-app-id').querySelector('span').classList.replace('text-yellow-400', 'text-green-500');
            document.getElementById('debug-app-id').querySelector('span').innerText = appId;
            
            // 3. ATTACH THE AUTH STATE OBSERVER (This will handle user state and run the final hideLoadingScreen)
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    await initializeUserFeatures(user.uid, user.email);
                    hideLoadingScreen();
                } else {
                    displayLoggedOutState();
                    hideLoadingScreen();
                }
            });
        }
    </script>
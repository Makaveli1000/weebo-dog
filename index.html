  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snt.L.Mo. Exclusive Sports Hub</title>
    
    <script src="/env-config.js"></script> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Define a custom color scheme based on St. Louis sports (Metro Blue/Red/Yellow) */
        .text-metro-primary { color: #0047AB; /* Navy Blue */ }
        .bg-metro-primary { background-color: #0047AB; }
        .border-metro-primary { border-color: #0047AB; }
        .text-metro-accent { color: #DC143C; /* Red */ }
        .bg-metro-accent { background-color: #DC143C; }
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); }
        .loading-overlay { display: flex; justify-content: center; align-items: center; background-color: rgba(255, 255, 255, 0.8); z-index: 100; }
        #tts-button {
            background-color: #ef4444; 
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #tts-button:hover:not(:disabled) {
            background-color: #dc2626; 
        }
        #tts-button:disabled {
            background-color: #9ca3af; 
            cursor: not-allowed;
        }
        /* Custom style for Zeus flying function */
        .flying-zeus {
            transition: transform 1s ease-out, opacity 1s ease-out;
            will-change: transform, opacity;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loading-overlay" class="fixed inset-0 loading-overlay z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-metro-primary mx-auto"></div>
            <p class="mt-4 text-gray-700 font-semibold">Initializing Zeus Hub Security...</p>
        </div>
    </div>

    <header class="bg-metro-primary text-white shadow-lg z-30">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold tracking-wider">SNTLMO Hub</h1>
            <div class="flex items-center space-x-4">
                <div class="hidden sm:flex items-center space-x-3 text-sm font-medium">
                    <span id="user-status-display" class="text-white">Logged Out</span>
                    <span class="bg-indigo-500 py-1 px-3 rounded-full hidden sm:block">ID: <span id="user-id-display" class="font-mono text-xs"></span></span>
                </div>
                <button id="header-auth-btn" onclick="toggleLoginModal(true)" class="bg-white text-metro-primary hover:bg-gray-200 px-3 py-1 rounded-full text-sm font-semibold transition hidden">Login/Register</button>
                <button id="account-btn" onclick="toggleAccountModal(true)" class="bg-white text-metro-primary hover:bg-gray-200 px-3 py-1 rounded-full text-sm font-semibold transition hidden">Account</button>
                <button id="admin-btn" onclick="toggleAdminModal(true)" class="bg-yellow-400 text-gray-900 hover:bg-yellow-500 px-3 py-1 rounded-full text-sm font-bold transition hidden">Admin</button>
            </div>
        </div>
    </header>

    <svg id="zeus-avatar-svg" class="w-10 h-10 fixed right-4 bottom-4 z-40 text-yellow-500 shadow-xl" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4.5H8.5l3.5-7v4.5H15l-3.5 7z"/>
        <path fill="none" d="M0 0h24v24H0z"/>
    </svg>

    <div id="paywall-content" class="flex-grow flex items-center justify-center p-8 hidden">
        <div class="max-w-xl text-center bg-white p-10 rounded-xl shadow-2xl border-t-4 border-metro-accent">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Access Denied: PRO MEMBERS ONLY</h2>
            <p class="text-lg text-gray-600 mb-6">You need to be a **PRO MEMBER** to access the live data feeds, chat, and locker room.</p>
            <button onclick="toggleCashAppModal(true)" class="bg-metro-accent text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-metro-accent/80 transition duration-300">
                Upgrade to PRO Membership ($10.00 / Year)
            </button>
            <p class="text-sm text-gray-500 mt-4">Already a member? Use the Login/Register button in the header.</p>
        </div>
    </div>
    
    <main id="main-content" class="flex-grow max-w-7xl mx-auto py-8 sm:px-6 lg:px-8 w-full hidden">
        <div class="px-4 py-6 sm:px-0">
            
            <div id="status-message-container" class="mb-4 hidden">
                <p id="status-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative font-medium"></p>
            </div>
            
            <button id="narrator-launch-btn" onclick="startZeusNarratorTour()" class="fixed top-20 right-4 z-40 bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-full shadow-xl hover:bg-yellow-500 hidden">
                Launch Zeus Tour!
            </button>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 space-y-8">
                    
                    <div class="bg-white shadow-xl rounded-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                            Live Sports Data Feed
                            <span id="latest-data" class="text-sm font-normal text-metro-primary">Awaiting data...</span>
                        </h2>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-3">
                            <h3 class="text-lg font-semibold text-gray-700">Broadcast Live Announcement (TTS)</h3>
                            <textarea id="tts-input" rows="2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-metro-primary focus:border-metro-primary" placeholder="Enter message to broadcast, e.g., 'The Vashon game starts in 5 minutes!'"></textarea>
                            <div class="flex justify-between items-center">
                                <button id="tts-button" onclick="window.generateAndSpeak()" disabled>
                                    Announce Now!
                                </button>
                                <div id="tts-status" class="text-xs font-medium text-gray-500">Status: Requires Gemini API Key</div>
                            </div>
                        </div>

                        <div class="mt-6 bg-indigo-50 p-6 rounded-lg border border-indigo-200">
                            <p class="text-indigo-800 font-medium">Raw Data Stream:</p>
                            <pre id="data-stream" class="text-sm text-indigo-700 mt-2 bg-indigo-100 p-3 rounded-md overflow-x-auto h-32">Awaiting real-time updates from Firestore...</pre>
                        </div>
                    </div>
                    
                    <div id="scoreboard-section" class="bg-white shadow-xl rounded-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                            Community Scoreboard & Highlights
                            <button onclick="toggleSportsDataModal(true)" class="bg-green-500 text-white font-bold py-1 px-3 rounded-full text-sm hover:bg-green-600 transition">
                                + Submit Data
                            </button>
                        </h2>
                        <div id="sports-data-display" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <p class="text-center text-gray-500 py-8 col-span-full">Loading sports data...</p>
                        </div>
                    </div>

                    <div id="interview-section" class="bg-white shadow-xl rounded-xl p-6">
                        <h2 id="interview-heading" class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">Exclusive Interview Corner</h2>
                        <p class="text-gray-600 mb-4">Submit your questions for our next featured St. Louis athlete!</p>
                        <textarea rows="3" class="w-full p-3 border rounded-lg focus:ring-metro-accent focus:border-metro-accent" placeholder="I'd like to ask..."></textarea>
                        <button class="mt-3 bg-metro-accent text-white font-bold py-2 px-5 rounded-full hover:bg-metro-accent/90 transition">
                            Submit Question
                        </button>
                    </div>

                    <div id="locker-room-section" class="bg-white shadow-xl rounded-xl p-6">
                        <h2 id="locker-heading" class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                            Personal Media Locker
                            <button id="locker-upload-btn" onclick="handleFileUpload()" class="bg-blue-500 text-white font-bold py-1 px-3 rounded-full text-sm hover:bg-blue-600 transition" disabled>
                                Upload Media
                            </button>
                        </h2>
                        <input type="file" id="media-file-input" class="hidden" onchange="handleFileUpload()">
                        <p id="locker-upload-message" class="text-sm text-red-500 font-medium my-2 hidden">
                            Limit reached! Upgrade to PRO for unlimited storage.
                        </p>
                        <p id="locker-status-text" class="text-sm text-orange-600 mb-4">Capacity: Loading...</p>
                        <div id="locker-media-display" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            </div>
                    </div>

                    <div class="bg-gray-800 text-white rounded-xl p-6 shadow-xl">
                        <h3 class="text-xl font-semibold border-b border-gray-600 pb-3 mb-4">System Health & Debug</h3>
                        <ul class="space-y-3 text-sm">
                            <li id="debug-firebase-config">Firebase Config: <span class="text-yellow-400">Checking...</span></li>
                            <li id="debug-auth-token">Initial Auth Token: <span class="text-yellow-400">Checking...</span></li>
                            <li id="debug-app-id">App ID: <span class="text-yellow-400">Checking...</span></li>
                        </ul>
                    </div>
                </div>
                
                <div class="lg:col-span-1 space-y-8">
                    
                    <div class="bg-white shadow-xl rounded-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">St. Louis Sports Birthdays</h3>
                        <div id="birthday-tracker-display" class="space-y-3">
                            </div>
                    </div>

                    <div class="card bg-green-50 p-6 rounded-xl shadow-lg border border-green-200">
                        <h3 class="text-xl font-bold text-green-700 mb-4">System Activity</h3>
                        <p class="text-gray-700">Last Database Ping:</p>
                        <div id="last-activity" class="text-xl font-extrabold text-green-600 mt-1">N/A</div>
                    </div>
                    
                    <div class="card bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-300 flex flex-col items-center">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Quick Share Link (QR)</h3>
                        <div id="qrcode-container" class="p-3 bg-white rounded-lg border border-gray-400">
                            </div>
                        <p class="text-xs text-gray-500 mt-3">Scan this code to immediately share the hub URL.</p>
                    </div>

                    <div class="bg-white shadow-xl rounded-xl p-6 h-96 flex flex-col">
                        <div class="flex justify-around mb-4 border-b pb-2">
                            <button id="mode-active-btn" onclick="toggleSidebarMode('ACTIVE')" class="text-sm font-bold p-2 rounded-lg bg-metro-primary text-white transition">Active Users</button>
                            <button id="mode-leaderboard-btn" onclick="toggleSidebarMode('LEADERBOARD')" class="text-sm font-bold p-2 rounded-lg bg-gray-200 text-gray-700 transition">Leaderboard</button>
                        </div>
                        <div class="flex-grow overflow-y-auto">
                            <div id="active-users-list" class="space-y-1">
                                </div>
                            <div id="leaderboard-list" class="space-y-1 hidden">
                                </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="chat-section" class="bg-white shadow-xl rounded-xl p-6 mt-8">
                <h2 id="chat-heading" class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">Team Chat</h2>
                
                <div id="chat-messages" class="h-64 overflow-y-auto p-4 mb-4 border border-gray-300 rounded-lg bg-gray-100 space-y-3">
                    <p class="text-center text-gray-500">Loading chat history...</p>
                </div>

                <div class="flex space-x-3">
                    <select id="chat-mode-toggle" onchange="toggleChatMode()" class="p-2 border rounded-lg text-sm bg-white">
                        <option value="public">Public</option>
                        <option value="private">Private (PM)</option>
                    </select>
                    <input type="text" id="recipient-id-input" placeholder="Recipient ID" class="hidden p-2 border rounded-lg text-sm w-1/4">
                    <input type="text" id="message-input" placeholder="Send a message to the team..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-metro-primary focus:border-metro-primary">
                    <button onclick="sendMessage('text')" class="bg-metro-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-metro-primary/80 transition">
                        Send
                    </button>
                </div>
                <div id="recipient-container" class="mt-2 text-sm text-gray-600 hidden">
                    <span id="recipient-display"></span>
                    <button id="video-call-btn" onclick="sendMessage('VIDEO_REQUEST', 'Video call request')" class="ml-3 bg-red-500 text-white text-xs font-bold py-1 px-2 rounded-full hover:bg-red-600 transition hidden">
                        üìπ Request Video Call
                    </button>
                </div>
            </div>

        </div>
    </main>

    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold text-metro-primary mb-4">Hub Login</h3>
            <p id="login-error" class="text-red-500 text-sm mb-3"></p>
            <input type="email" id="login-email" placeholder="Email" class="w-full p-3 mb-3 border rounded-lg">
            <input type="password" id="login-password" placeholder="Password (min 6 chars)" class="w-full p-3 mb-4 border rounded-lg">
            
            <button onclick="logIn()" class="w-full bg-metro-primary text-white font-bold py-3 rounded-lg hover:bg-metro-primary/80 transition mb-2">Login</button>
            <button onclick="register()" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition mb-4">Register</button>
            
            <p class="text-xs text-gray-500 mb-3">--- OR USE QR LOGIN ---</p>
            <div id="login-qrcode" class="mx-auto w-[100px] h-[100px] mb-3"></div>
            <input type="text" id="login-qr-id-input" readonly class="w-full p-2 text-sm text-center border rounded-lg bg-gray-100 mb-2" onclick="copyQrCodeText()" title="Click to copy User ID">
            <button onclick="copyQrCodeText()" class="text-xs text-metro-accent hover:underline">Copy User ID</button>

            <button onclick="toggleLoginModal(false)" class="text-gray-500 hover:text-gray-700 mt-4 block mx-auto text-sm">Close</button>
        </div>
    </div>
    
    <div id="account-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
            <h3 class="text-2xl font-bold text-metro-primary mb-4">Account Settings</h3>
            <div class="space-y-4">
                <p class="text-sm">UID: <span id="account-uid" class="font-mono text-xs bg-gray-100 p-1 rounded"></span></p>
                <p class="text-sm">Premium Status: <span id="account-premium-status" class="font-bold"></span></p>
                
                <div>
                    <label for="account-nickname" class="block text-sm font-medium text-gray-700">Nickname:</label>
                    <div class="flex space-x-2 mt-1">
                        <input type="text" id="account-nickname" class="flex-grow p-2 border rounded-lg">
                        <button onclick="saveAccountNickname()" class="bg-metro-primary text-white text-sm font-bold px-3 rounded-lg hover:bg-metro-primary/80">Save</button>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <label for="account-new-password" class="block text-sm font-medium text-gray-700">Change Password:</label>
                    <input type="password" id="account-new-password" placeholder="New Password (min 6 chars)" class="w-full p-2 mt-1 border rounded-lg">
                    <p id="account-password-error" class="text-red-500 text-xs mt-1"></p>
                    <button onclick="updateUserPassword()" class="mt-3 bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Update Password</button>
                </div>
                
                <button onclick="logOut(); toggleAccountModal(false);" class="mt-4 bg-gray-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Log Out</button>
            </div>
            <button onclick="toggleAccountModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>

    <div id="cashapp-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold text-metro-primary mb-4">PRO MEMBERSHIP - $10.00</h3>
            <p class="text-gray-700 mb-4">Please scan the QR code to complete payment via Cash App.</p>
            <div id="cashapp-qrcode" class="mx-auto w-[180px] h-[180px] mb-4"></div>
            <p class="text-lg font-bold text-green-600 mb-2">Cash Tag: $Mac100dime</p>
            <p class="text-xs text-red-500 mb-4">After payment, click "Simulate Success" below for instant access.</p>
            <button onclick="simulatePaymentSuccess()" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition mb-3">
                Simulate Payment Success (Get Access Now)
            </button>
            <button onclick="toggleCashAppModal(false)" class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
        </div>
    </div>
    
    <div id="sports-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold text-metro-primary mb-4">Submit Sports Data</h3>
            <p class="text-red-500 text-sm mb-3">Contribution increases your standing on the Leaderboard!</p>
            
            <div class="space-y-3">
                <select id="data-type" class="w-full p-3 border rounded-lg">
                    <option value="SCORE">Live Score Update</option>
                    <option value="HIGHLIGHT">Highlight Video/Clip</option>
                    <option value="ACTIVITY">General Team Activity</option>
                </select>
                
                <select id="data-school" class="w-full p-3 border rounded-lg">
                    <option value="VASHON">VASHON - Wolverines üê∫</option>
                    <option value="SUMNER">SUMNER - Bulldogs üê∂</option>
                    <option value="SOLDAN">SOLDAN - Tigers üêÖ</option>
                    <option value="MCKINLEY">MCKINLEY - Goldbugs üêû</option>
                    <option value="ROOSEVELT">ROOSEVELT - Rough Riders üêé</option>
                    <option value="OTHER">Other STL Area School</option>
                </select>
                
                <input type="text" id="data-title" placeholder="Title (e.g., Vashon 68 - Soldan 55)" class="w-full p-3 border rounded-lg">
                <textarea id="data-details" rows="3" placeholder="Details (e.g., 4th quarter score difference)" class="w-full p-3 border rounded-lg"></textarea>
                <input type="url" id="data-video-url" placeholder="Optional: YouTube/Highlight Video URL" class="w-full p-3 border rounded-lg">
            </div>
            
            <button onclick="flyZeusAndClick('submit-data-btn', submitSportsData, 800)" id="submit-data-btn" class="w-full mt-6 bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition">
                Submit Data to Scoreboard
            </button>
            
            <button onclick="toggleSportsDataModal(false)" class="mt-4 text-gray-500 hover:text-gray-700 text-sm block mx-auto">Cancel</button>
            <button onclick="window.upgradeToPremiumForOneYear()" class="text-xs text-red-400 hover:text-red-600 block mx-auto mt-2">ADMIN: Test Upgrade</button>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-3xl w-full h-4/5 flex flex-col">
            <h3 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">Admin Panel (User Management)</h3>
            <p class="text-sm text-gray-600 mb-4">Admin UID: <span class="font-mono text-xs text-red-700">05806734626095127961</span></p>

            <div class="grid grid-cols-5 gap-2 font-bold text-sm text-gray-700 mb-2 border-b-2 pb-2">
                <div>Nickname</div>
                <div>UID (Partial)</div>
                <div>Status</div>
                <div>Expires</div>
                <div>Actions</div>
            </div>
            
            <div id="admin-users-list" class="flex-grow overflow-y-auto space-y-1">
                <p class="text-gray-500 text-center py-4">Loading user list...</p>
            </div>

            <button onclick="toggleAdminModal(false)" class="mt-4 bg-gray-500 text-white font-bold py-2 rounded-lg hover:bg-gray-600 transition">Close Admin Panel</button>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, where, increment, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration and Initialization (MANDATORY GLOBALS)
        // FIX 1: Read variables from the injected 'window' object, which Netlify creates.
        const appId = typeof window.__app_id !== 'undefined' ?
        window.__app_id : 'default-app-id';

        // CORRECTED FIREBASE CONFIGURATION LINE (FIXES NETLIFY NAMING CONFLICT):
        const firebaseConfig = (typeof window.NETLIFY_FIREBASE_CONFIG !== 'undefined' ? window.NETLIFY_FIREBASE_CONFIG : window.__firebase_config) || null;
        // -------------------------------------------------------------------------
        // FIX 2: Corrected the ReferenceError (using window.__initialAuthToken)
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null; 

        const GEMINI_API_KEY = typeof window.GEMINI_API_KEY !== 'undefined' ? window.GEMINI_API_KEY : '';
        
        // --- ADMIN SECURITY CONFIGURATION (CRUCIAL) ---
        const ADMIN_USER_ID = "05806734626095127961";
        // --- END ADMIN CONFIG ---

        // --- GLOBAL ERROR HANDLER ---
        window.addEventListener('error', function(event) {
            console.error('*** Global Error Handler Caught Exception ***');
            console.error('Error Message:', event.message);
            
            if (event.target && event.target.tagName) {
                const tag = event.target.tagName.toLowerCase();
                if (tag === 'script' || tag === 'link' || tag === 'img' || event.message.includes('404')) {
                    console.error('Source causing 404-like error:', event.target.src || event.target.href || 'Unknown Source');
                }
            }
        });

        // --- TTS LONG MOTIVATIONAL SPEECH (Used by Zeus) ---
        const LONG_MOTIVATIONAL_SPEECH = "Champions rise and fall not on game day, but in the relentless, grinding hours of preparation. This is the truth of the arena. Every repetition, every drop of sweat, every moment of self-doubt conquered builds the fortress of your dominance. The clock is ticking on yesterday's efforts, and today demands more. Today, the world is watching, waiting for the thunder of your excellence. Do not give them average. Give them relentless. Give them legendary. You have the heart of a champion, the spirit of St. Louis, and the will of Zeus. Now, go seize your moment! The legacy is yours for the taking. Remember why you started this journey and finish the fight. You are the exclusive few. You are the best of Missouri. Finish strong, finish loud, and leave no doubt! You are the final countdown to victory, make this moment count!";
        
        // --- ZEUS RANDOM PHRASES & SCHOOL MASCOT ICONS ---
        const ZEUS_PHRASES = [
            "Great choice! Now you're cooking.", "Big time! Let's get that data recorded.", "Zeus approves! The hub gets stronger.", "That's how champions move. Data collected.", 
            "Strike hard! Mission accomplished.", "A move worthy of the Thunder God! Excellent.", "Feel the lightning! You're making history.", "Unstoppable! Carry on, champion.",
            "A stroke of genius! The Gods demand excellence.", "By Olympus! That data is gold.", "Feel the force of the Thunder God! Progress secured.", "The lightning never misses. Great input.",
            "That's a championship move, right there!", "Lock it in! Focus and finish.", "Level up the whole damn team! Fantastic work.", "We call that dominance! Keep the scores coming.",
            "BOOM! Data locked.", "Money time! Solid effort.", "All business. Move quick.", "Executed! Nothing else matters.",
            "Your command is absolute! Proceeding with access.", 
            "Account secured. Let the games begin!" 
        ];
        function getRandomPhrase() { return ZEUS_PHRASES[Math.floor(Math.random() * ZEUS_PHRASES.length)]; }
        
        const SCHOOL_ICONS = { "VASHON": "üê∫", "SUMNER": "üê∂", "SOLDAN": "üêÖ", "MCKINLEY": "üêû", "ROOSEVELT": "üêé", "LADUE": "üêè", 
            "KIRKWOOD": "üèà", "WEBSTER": "Statesman", "SLUH": "‚öîÔ∏è", "WHITFIELD": "üõ°Ô∏è", "LSW": "ü¶Å", "BLUESPRINGS": "üêæ", 
            "ROCKHURST": "ü¶Ö", "HICKMAN": "üêâ", "ROCKBRIDGE": "üêª", "KICKAPOO": "‚öîÔ∏è", "GLENDALE": "Falcon", "OTHER": "üèÜ"
        };

        // --- WEB AUDIO API SETUP / TTS FUNCTIONALITY ---
        let audioContext; 

        function createNoiseSource(volume) {
            const bufferSize = 2 * (audioContext?.sampleRate || 44100);
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1; 
            }

            const source = audioContext.createBufferSource();
            source.buffer = noiseBuffer;
            source.loop = true;

            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;

            source.connect(gainNode);
            return { source, gainNode };
        }

        function stopSFX(thunderSource, cheerSource, cheerGain) {
            if (thunderSource) {
                try { thunderSource.stop(); } catch(e) {}
            }
            if (cheerSource) {
                try { cheerSource.stop(); } catch(e) {}
            }
            if (cheerGain) {
                try { cheerGain.disconnect(); } catch(e) {}
            }
        }

        // --- Core Initialization Variables and Setup ---
        window.app = null;
        window.db = null;
        window.auth = null;
        window.serverTimestamp = null;
        window.currentUserId = null;
        window.isLoggedIn = false;
        window.isPremium = false; 
        window.nickname = 'Guest';
        window.dbRef = {}; 

        if (!firebaseConfig) { 
            console.error("Firebase config not found. The app will not function.");
        } else {
            setLogLevel('Debug');
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            window.serverTimestamp = serverTimestamp;

            window.chatMode = 'public'; 
            window.recipientId = '';
            window.sportsDataFilter = 'ALL';
            window.sidebarMode = 'ACTIVE'; 
            window.streamTab = 'HS_COLLEGE'; 
            window.lockerMediaCount = 0;
        }
        
        // --- TTS API IMPLEMENTATION ---
        window.generateAndSpeak = async function(speechText) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const textInput = document.getElementById('tts-input');
            const text = speechText || textInput.value.trim();
            const btn = document.getElementById('tts-button');
            
            if (!text) return;

            if (!GEMINI_API_KEY) {
                alert("TTS Error: Gemini API Key is missing. Check Netlify Environment Variables.");
                return;
            }

            btn.disabled = true;
            btn.innerText = 'Analyzing...';

            let thunderSource = null, cheerSource = null, cheerGain = null;
            const startTime = audioContext.currentTime;
            let audio = null; 

            try {
                // Start SFX
                const thunder = createNoiseSource(0.05);
                thunderSource = thunder.source;
                thunder.gainNode.connect(audioContext.destination);
                thunderSource.start(startTime);

                const cheer = createNoiseSource(0);
                cheerSource = cheer.source;
                cheerGain = cheer.gainNode;
                cheerGain.connect(audioContext.destination);
                cheerSource.start(startTime);
                
                cheerGain.gain.setValueAtTime(0, startTime);
                cheerGain.gain.linearRampToValueAtTime(0.5, startTime + 20);

                const payload = {
                    contents: [{
                        parts: [{ text: `Act as a highly energetic St. Louis High School Sports Analyst.
                        Deliver the following text with firm, motivating energy: ${text}` }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`; 

                const maxRetries = 5;
                let attempt = 0;
                let response;
                while (attempt < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            if (response.status === 404 || response.status === 503) {
                                throw new Error(`API returned HTTP ${response.status}. The external service may be down or the URL is incorrect.`);
                            }
                        }

                        if (response.ok) break;

                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempt++;
                    } catch (error) {
                        if (error.message.includes('API returned HTTP')) {
                            throw error; 
                        }
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempt++;
                    }
                }

                if (!response || !response.ok) throw new Error(`API request failed after ${maxRetries} attempts.`);
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const match = mimeType.match(/rate=(\d+)/);
                    const sampleRate = match ? parseInt(match[1], 10) : 16000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audio = new Audio(audioUrl); 
                    audio.addEventListener('ended', () => {
                        stopSFX(thunderSource, cheerSource, cheerGain);
                        URL.revokeObjectURL(audioUrl); 
                        audio = null;
                    });
                    audio.play();
                } else {
                    console.error("Audio data missing or invalid type:", mimeType);
                    stopSFX(thunderSource, cheerSource, cheerGain); 
                }

            } catch (error) {
                alert(`ZEUS TTS FAILED: ${error.message || 'Check console for network error.'}`);
                console.error("TTS Generation Error:", error);
                stopSFX(thunderSource, cheerSource, cheerGain); 
            } finally {
                if (audio) {
                    stopSFX(thunderSource, cheerSource, cheerGain);
                }
                btn.disabled = false;
                btn.innerText = 'Generate Analysis & Speak!';
            }
        }
        
        // --- Core Application Functions (Auth / Status Control) ---
        async function authenticate() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (!window.db) {
                document.getElementById('paywall-content').classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
                return;
            }
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    // Logic waits for user interaction (login/register)
                }
            } catch (error) {
                console.error("Authentication failed during auto-sign-in:", error);
                document.getElementById('paywall-content').classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
            }
        }

        onAuthStateChanged(window.auth, (user) => {
            const loginModal = document.getElementById('login-modal');
            const headerAuthBtn = document.getElementById('header-auth-btn');
            const accountBtn = document.getElementById('account-btn');
            
            const adminBtn = document.getElementById('admin-btn');

            if (user) {
                window.currentUserId = user.uid;
                window.isLoggedIn = true;
                
                loginModal.classList.add('hidden');
                
                headerAuthBtn.classList.add('hidden');
                accountBtn.classList.remove('hidden'); 
                
                // Show Admin Button if user is the Admin
                adminBtn.classList.toggle('hidden', user.uid !== ADMIN_USER_ID);

                window.dbRef = {
                    users: (uid) => doc(window.db, `artifacts/${appId}/users/${uid}/profile/info`),
                    allUsersCollection: collection(window.db, `artifacts/${appId}/users`), 
                    publicMessages: collection(window.db, `artifacts/${appId}/public/data/messages`),
                    activeUsersCollection: collection(window.db, `artifacts/${appId}/public/data/active_users`),
                    sportsData: collection(window.db, `artifacts/${appId}/public/data/sports_data`),
                    leaderboard: collection(window.db, `artifacts/${appId}/public/data/leaderboard`),
                    mediaLocker: (uid) => collection(window.db, `artifacts/${appId}/users/${uid}/media_locker`),
                    mediaComments: (uid, mediaId) => collection(window.db, `artifacts/${appId}/users/${uid}/media_locker/${mediaId}/comments`) 
                };
                
                loadUserStatusAndContent();
            } else {
                window.currentUserId = null;
                window.isLoggedIn = false;
                window.isPremium = false;
                document.getElementById('main-content').classList.add('hidden'); 
                document.getElementById('paywall-content').classList.remove('hidden'); 
                
                headerAuthBtn.classList.remove('hidden'); 
                accountBtn.classList.add('hidden'); 
                adminBtn.classList.add('hidden');
            }
        });
        
        async function loadUserStatusAndContent() {
            const mainContent = document.getElementById('main-content');
            const paywallContent = document.getElementById('paywall-content');
            let isExpired = false;

            try {
                const docSnap = await getDoc(window.dbRef.users(window.currentUserId));
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    window.nickname = userData.nickname || 'Guest';
                    
                    if (userData.premiumExpires && userData.premiumExpires.toDate) {
                        const expirationDate = userData.premiumExpires.toDate();
                        if (expirationDate < new Date()) {
                            isExpired = true;
                        }
                    }
                    
                    window.isPremium = (userData.isPremium && !isExpired) || false;

                    renderUserStatus(userData); 

                    if (window.isPremium) {
                        mainContent.classList.remove('hidden');
                        paywallContent.classList.add('hidden');
                        
                        // PHASE 2: CALL ALL IMPLEMENTED LISTENERS
                        setupPresenceTracking(window.currentUserId);
                        setupChatListener();
                        setupSportsDataListener();
                        setupLeaderboardListener();
                        setupLockerRoomListener();
                        
                        if (!userData.tourCompleted) {
                            document.getElementById('narrator-launch-btn').classList.remove('hidden');
                        } else {
                            document.getElementById('narrator-launch-btn').classList.add('hidden');
                        }

                    } else {
                        mainContent.classList.add('hidden');
                        paywallContent.classList.remove('hidden');
                    }
                } else {
                    // Default to paywall if profile document doesn't exist
                    mainContent.classList.add('hidden');
                    paywallContent.classList.remove('hidden');
                    renderUserStatus({});
                }
            } catch (error) {
                console.error("Error loading user status:", error);
                mainContent.classList.add('hidden');
                paywallContent.classList.remove('hidden');
                renderUserStatus({});
            }
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        // --- UX FUNCTION: Renders Nickname, Status, and Expiration ---
        function renderUserStatus(userData) {
            const statusDisplay = document.getElementById('user-status-display');
            const idDisplay = document.getElementById('user-id-display');
            const expiry = userData.premiumExpires?.toDate ? userData.premiumExpires.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
            
            if (!window.isLoggedIn) {
                statusDisplay.innerHTML = 'Logged Out';
                idDisplay.innerText = '';
                return;
            }
            
            idDisplay.innerText = window.currentUserId.substring(0, 8) + '...';
            idDisplay.title = window.currentUserId;
            
            let html = `<span class="font-bold text-metro-accent mr-2" id="nickname-display">${window.nickname}</span>`;
            if (window.isPremium) {
                html += `<span class="text-xs font-bold text-white bg-green-600 px-2 py-0.5 rounded-full mr-3">‚≠ê PRO MEMBER</span>`;
                html += `<span class="text-xs text-gray-500">Expires: ${expiry}</span>`;
            } else {
                html += `<span class="text-xs font-bold text-white bg-red-500 px-2 py-0.5 rounded-full">STANDARD</span>`;
            }

            statusDisplay.innerHTML = html;
            // Update Account Modal
            document.getElementById('account-uid').innerText = window.currentUserId;
            document.getElementById('account-nickname').value = window.nickname;
            document.getElementById('account-premium-status').innerText = window.isPremium ? `Active (Expires ${expiry})` : 'Inactive';
            document.getElementById('account-premium-status').className = window.isPremium ?
            'text-green-600 font-bold' : 'text-red-500 font-bold';
        }
        // --- END UX FUNCTION ---
        
        // --- HELPER FUNCTIONS (TTS Audio Encoding) ---
        function base64ToArrayBuffer(base64) {
             const binaryString = atob(base64);
             const len = binaryString.length;
             const bytes = new Uint8Array(len);
             for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
             return bytes.buffer;
        }
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = (sampleRate * numChannels * bitsPerSample) / 8;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE'); view.setUint32(12, 12, true); writeString(view, 16, 'fmt '); view.setUint32(20, 16, true);
            view.setUint16(24, 1, true); view.setUint16(26, numChannels, true); view.setUint32(28, sampleRate, true);
            view.setUint32(32, byteRate, true); view.setUint16(36, blockAlign, true); view.setUint16(38, bitsPerSample, true);
            writeString(view, 40, 'data'); view.setUint32(44, pcm16.length * 2, true);
            let offset = 48;
            for (let i = 0; i < pcm16.length; i++) { view.setInt16(offset, pcm16[i], true); offset += 2; }
            return new Blob([view], { type: 'audio/wav' });
        }
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); }
        }

        // =========================================================================
        // --- FINAL CONSOLIDATED FUNCTION LIST (PHASES 1, 2, 3 & UTILITIES) ---
        // =========================================================================
        
        // 1. Modal Toggle Functions (Corrected and Cleaned Log)
        function toggleLoginModal(show = true) {
            const modal = document.getElementById('login-modal');
            modal.classList.toggle('hidden', !show);
            console.log(`LOG: Toggled Login Modal: ${show ? 'Show' : 'Hide'}`);
        }
        function toggleAccountModal(show = true) {
            const modal = document.getElementById('account-modal');
            modal.classList.toggle('hidden', !show);
            console.log(`LOG: Toggled Account Modal: ${show ? 'Show' : 'Hide'}`);
        }
        function toggleAdminModal(show = true) {
            const modal = document.getElementById('admin-modal');
            modal.classList.toggle('hidden', !show);
            console.log(`LOG: Toggled Admin Modal: ${show ? 'Show' : 'Hide'}`);
        }
        function toggleCashAppModal(show = true) {
            const modal = document.getElementById('cashapp-modal');
            modal.classList.toggle('hidden', !show);
            console.log(`LOG: Toggled CashApp Modal: ${show ? 'Show' : 'Hide'}`);
        }
        function toggleSportsDataModal(show = true) {
            const modal = document.getElementById('sports-data-modal');
            modal.classList.toggle('hidden', !show);
            console.log(`LOG: Toggled Sports Data Modal: ${show ? 'Show' : 'Hide'}`);
        }

        // 2. Authentication Functions (Phase 1 Implemented)
        async function logIn() {
            console.log("LOG: logIn called - Implementing Firebase sign-in.");
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDisplay = document.getElementById('login-error');
            errorDisplay.innerText = '';

            if (!email || password.length < 6) {
                errorDisplay.innerText = 'Email is required and password must be at least 6 characters.';
                return;
            }

            try {
                await signInWithEmailAndPassword(window.auth, email, password);
            } catch (error) {
                let message = 'Login failed. Please check your credentials.';
                if (error.code === 'auth/user-not-found') message = 'No account found for this email.';
                if (error.code === 'auth/wrong-password') message = 'Incorrect password.';
                errorDisplay.innerText = message;
                console.error("Login Error:", error);
            }
        }
        async function register() {
            console.log("LOG: register called - Implementing Firebase registration.");
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDisplay = document.getElementById('login-error');
            errorDisplay.innerText = '';

            if (!email || password.length < 6) {
                errorDisplay.innerText = 'Email is required and password must be at least 6 characters.';
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;
                
                await setDoc(doc(window.db, `artifacts/${appId}/users/${user.uid}/profile/info`), {
                    nickname: email.split('@')[0],
                    email: user.email,
                    isPremium: false,
                    joinedDate: window.serverTimestamp(),
                    score: 0
                });

            } catch (error) {
                let message = 'Registration failed. Try again.';
                if (error.code === 'auth/email-already-in-use') message = 'This email is already registered.';
                if (error.code === 'auth/weak-password') message = 'Password is too weak. Must be 6+ characters.';
                errorDisplay.innerText = message;
                console.error("Registration Error:", error);
            }
        }
        function logOut() {
            console.log("LOG: logOut called - Implementing Firebase sign out.");
            if (window.auth) {
                signOut(window.auth)
                    .catch((error) => {
                        console.error("Sign Out Error:", error);
                    });
            }
        }
        async function simulatePaymentSuccess() {
            console.log("LOG: simulatePaymentSuccess called - Granting Premium Access.");
            if (!window.currentUserId || !window.db) {
                alert("Must be logged in to upgrade!");
                return;
            }

            try {
                const expiryDate = new Date();
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);

                await updateDoc(doc(window.db, `artifacts/${appId}/users/${window.currentUserId}/profile/info`), {
                    isPremium: true,
                    premiumExpires: expiryDate,
                    score: increment(10)
                });
                
                window.isPremium = true;
                
                toggleCashAppModal(false); 
                alert("PRO Membership Activated! Welcome to the Hub!");
                loadUserStatusAndContent();
                
            } catch (error) {
                console.error("Payment Simulation Error:", error);
                alert("Failed to activate premium status. Check console for details.");
            }
        }

        // 3. Real-Time Listeners (Phase 2 Implemented)
        function setupChatListener() {
            console.log("LOG: setupChatListener: Setting up real-time chat listener.");
            if (!window.dbRef.publicMessages) return;
            const q = query(window.dbRef.publicMessages, orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(q, (snapshot) => {
                const chatMessagesDiv = document.getElementById('chat-messages');
                let html = '';
                snapshot.docs.reverse().forEach((doc) => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : 'N/A';
                    const sender = data.nickname || 'Unknown User';
                    const isSelf = data.uid === window.currentUserId;
                    html += `<div class="text-sm ${isSelf ? 'text-right' : 'text-left'}"><span class="font-bold ${isSelf ? 'text-metro-accent' : 'text-metro-primary'}">${sender}:</span><span>${data.message}</span><span class="text-xs text-gray-400 ml-2">${timestamp}</span></div>`;
                });
                chatMessagesDiv.innerHTML = html || '<p class="text-center text-gray-500">No messages yet.</p>';
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            });
        }
        function setupSportsDataListener() {
            console.log("LOG: setupSportsDataListener: Setting up real-time sports data listener.");
            if (!window.dbRef.sportsData) return;
            const q = query(window.dbRef.sportsData, orderBy('timestamp', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
                const displayDiv = document.getElementById('sports-data-display');
                let html = '';
                if (snapshot.empty) {
                    displayDiv.innerHTML = '<p class="text-center text-gray-500 py-8 col-span-full">No data submitted yet. Be the first!</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const icon = window.SCHOOL_ICONS[data.school] || window.SCHOOL_ICONS['OTHER'];
                    const timeAgo = data.timestamp ? Math.round((new Date() - data.timestamp.toDate()) / 60000) + 'm ago' : 'Just now';
                    html += `<div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-metro-accent"><div class="flex items-center justify-between mb-2"><span class="text-xl">${icon}</span><span class="text-xs text-gray-500">${timeAgo} by ${data.nickname}</span></div><h4 class="font-semibold text-gray-800">${data.title}</h4><p class="text-sm text-gray-600 truncate">${data.details}</p><span class="text-xs font-mono text-metro-primary">${data.type} Update</span></div>`;
                });
                displayDiv.innerHTML = html;
                document.getElementById('latest-data').innerText = `Last update: ${new Date().toLocaleTimeString()}`;
            });
        }
        function setupLeaderboardListener() {
            console.log("LOG: setupLeaderboardListener: Setting up real-time leaderboard.");
            if (!window.dbRef.leaderboard) return;
            const q = query(window.dbRef.leaderboard, orderBy('score', 'desc'), limit(5));
            onSnapshot(q, (snapshot) => {
                const leaderboardList = document.getElementById('leaderboard-list');
                let html = '<h4 class="text-lg font-bold text-gray-800 mb-2">Top Contributors:</h4>';
                let rank = 1;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const isCurrentUser = data.uid === window.currentUserId;
                    html += `<div class="flex justify-between items-center p-2 rounded-md ${isCurrentUser ? 'bg-yellow-100 font-bold' : 'hover:bg-gray-50'}"><span class="text-sm">${rank}. ${data.nickname}</span><span class="text-metro-primary font-extrabold">${data.score} pts</span></div>`;
                    rank++;
                });
                leaderboardList.innerHTML = html;
            });
        }
        function setupLockerRoomListener() {
            console.log("LOG: setupLockerRoomListener: Setting up real-time locker.");
            if (!window.dbRef.mediaLocker) return;
            const q = query(window.dbRef.mediaLocker(window.currentUserId), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const displayDiv = document.getElementById('locker-media-display');
                window.lockerMediaCount = snapshot.size;
                document.getElementById('locker-status-text').innerText = `Capacity: ${snapshot.size}/10 Files (Standard) - Upgrade for unlimited.`;
                let html = '';
                if (snapshot.empty) {
                    displayDiv.innerHTML = '<p class="text-center text-gray-500 py-4 col-span-full">Your locker is empty. Upload media!</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const isVideo = data.mimeType && data.mimeType.startsWith('video');
                    html += `<div class="card p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200 overflow-hidden"><p class="font-bold text-sm truncate mb-1">${data.fileName}</p><p class="text-xs text-gray-600">${data.sizeKB} KB - ${isVideo ? 'Video' : 'Image'}</p><a href="${data.url}" target="_blank" class="text-xs text-metro-accent hover:underline mt-1 block">View/Download</a></div>`;
                });
                displayDiv.innerHTML = html;
            });
        }
        function setupPresenceTracking(uid) {
            console.log("LOG: setupPresenceTracking: Initializing presence tracking for:", uid);
            if (!window.dbRef.activeUsersCollection) return;
            const userDocRef = doc(window.dbRef.activeUsersCollection, uid);
            setDoc(userDocRef, {
                uid: uid,
                nickname: window.nickname,
                lastActive: new Date(),
                isOnline: true
            }).catch(e => console.error("Error setting initial presence:", e));
        }

        // 4. User Interaction and Management (Phase 3 Implemented)
        async function sendMessage(type = 'text') {
            console.log(`LOG: sendMessage called - Type: ${type}`);
            if (!window.isLoggedIn || !window.dbRef.publicMessages) {
                alert("You must be logged in to send a message.");
                return;
            }
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            if (!message && type === 'text') return;
            try {
                await addDoc(window.dbRef.publicMessages, {
                    uid: window.currentUserId,
                    nickname: window.nickname,
                    message: message,
                    type: type,
                    timestamp: window.serverTimestamp()
                });
                messageInput.value = '';
                console.log("Message sent successfully.");
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message. Check console.");
            }
        }
        async function submitSportsData() {
            console.log("LOG: submitSportsData called - Saving new sports data entry.");
            if (!window.isPremium || !window.dbRef.sportsData) {
                alert("You must be a PRO MEMBER to submit data.");
                return;
            }
            const dataType = document.getElementById('data-type').value;
            const dataSchool = document.getElementById('data-school').value;
            const dataTitle = document.getElementById('data-title').value.trim();
            const dataDetails = document.getElementById('data-details').value.trim();
            const dataVideoUrl = document.getElementById('data-video-url').value.trim();
            if (!dataTitle || !dataDetails) {
                alert("Title and Details are required for submission.");
                return;
            }
            try {
                await addDoc(window.dbRef.sportsData, {
                    uid: window.currentUserId,
                    nickname: window.nickname,
                    type: dataType,
                    school: dataSchool,
                    title: dataTitle,
                    details: dataDetails,
                    videoUrl: dataVideoUrl || null,
                    timestamp: window.serverTimestamp()
                });
                await updateDoc(doc(window.db, `artifacts/${appId}/users/${window.currentUserId}/profile/info`), {
                    score: increment(5)
                });
                toggleSportsDataModal(false);
                alert("Sports Data submitted! Score updated.");
            } catch (error) {
                console.error("Error submitting sports data:", error);
                alert("Failed to submit data. Check console.");
            }
        }
        function toggleChatMode() {
            console.log("LOG: toggleChatMode called - Toggling chat mode.");
            const modeSelect = document.getElementById('chat-mode-toggle');
            const recipientInput = document.getElementById('recipient-id-input');
            window.chatMode = modeSelect.value;
            if (window.chatMode === 'private') {
                recipientInput.classList.remove('hidden');
            } else {
                recipientInput.classList.add('hidden');
            }
            console.log(`Chat Mode set to: ${window.chatMode}`);
        }
        function toggleSidebarMode(mode) {
            console.log(`LOG: toggleSidebarMode called - Switching sidebar to: ${mode}`);
            window.sidebarMode = mode;
            const activeList = document.getElementById('active-users-list');
            const leaderboardList = document.getElementById('leaderboard-list');
            const activeBtn = document.getElementById('mode-active-btn');
            const leaderboardBtn = document.getElementById('mode-leaderboard-btn');
            if (mode === 'LEADERBOARD') {
                leaderboardList.classList.remove('hidden');
                activeList.classList.add('hidden');
                leaderboardBtn.classList.add('bg-metro-primary', 'text-white');
                leaderboardBtn.classList.remove('bg-gray-200', 'text-gray-700');
                activeBtn.classList.remove('bg-metro-primary', 'text-white');
                activeBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else { // 'ACTIVE'
                activeList.classList.remove('hidden');
                leaderboardList.classList.add('hidden');
                activeBtn.classList.add('bg-metro-primary', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                leaderboardBtn.classList.remove('bg-metro-primary', 'text-white');
                leaderboardBtn.classList.add('bg-gray-200', 'text-gray-700');
            }
        }
        async function saveAccountNickname() {
            console.log("LOG: saveAccountNickname called - Updating user nickname.");
            if (!window.currentUserId) return;
            const newNickname = document.getElementById('account-nickname').value.trim();
            if (!newNickname) {
                alert("Nickname cannot be empty.");
                return;
            }
            try {
                await updateDoc(doc(window.db, `artifacts/${appId}/users/${window.currentUserId}/profile/info`), {
                    nickname: newNickname
                });
                window.nickname = newNickname;
                renderUserStatus({}); 
                alert("Nickname saved successfully!");
            } catch (error) {
                console.error("Error saving nickname:", error);
                alert("Failed to save nickname. Check console.");
            }
        }
        async function updateUserPassword() {
            console.log("LOG: updateUserPassword called - Attempting password change.");
            if (!window.auth.currentUser) {
                alert("You must be recently logged in to change your password.");
                return;
            }
            const newPassword = document.getElementById('account-new-password').value;
            const errorDisplay = document.getElementById('account-password-error');
            errorDisplay.innerText = '';
            if (newPassword.length < 6) {
                errorDisplay.innerText = 'Password must be at least 6 characters.';
                return;
            }
            try {
                await updatePassword(window.auth.currentUser, newPassword);
                errorDisplay.innerText = 'Password updated successfully!';
                errorDisplay.classList.remove('text-red-500');
                errorDisplay.classList.add('text-green-600');
                document.getElementById('account-new-password').value = ''; 
            } catch (error) {
                let message = 'Failed to update. Try logging out and back in, then retry.';
                if (error.code === 'auth/requires-recent-login') {
                    message = 'Security alert: Please log out and log back in, then retry updating your password.';
                }
                errorDisplay.innerText = message;
                console.error("Password Update Error:", error);
            }
        }
        function handleFileUpload() {
            console.log("LOG: handleFileUpload called - [STUB] - Needs Firebase Storage implementation.");
            alert("File upload is not yet implemented. Please check console.");
        }

        // 5. Utilities (Stubs)
        function generateLoginQR() {
            console.log("LOG: generateLoginQR called - [STUB] - Needs qrcode.min.js implementation.");
        }
        function startZeusNarratorTour() {
            console.log("LOG: startZeusNarratorTour called - [STUB] - Launching UI/Voice Tour.");
            alert("The Zeus Narrator Tour is running! (Check console for next steps)");
        }
        function flyZeusAndClick(targetElementId, clickFunction, duration = 1000) {
            console.log(`LOG: flyZeusAndClick called - Animating Zeus to click ${targetElementId}`);
            if (typeof clickFunction === 'function') {
                clickFunction();
            }
        }
        // =========================================================================
        // --- END OF CONSOLIDATED FUNCTION LIST ---
        // =========================================================================

        // Final function calls to start the app
        document.addEventListener('DOMContentLoaded', () => {
            authenticate();
            // Assuming renderBirthdayTracker is defined and runs here
        }); 
    </script>
</body>
</html>